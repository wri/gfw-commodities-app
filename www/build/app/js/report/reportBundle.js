define("utils/Analytics",[],function(){"use strict";return{sendEvent:function(e,t,n,r){var i={hitType:"event",eventCategory:e,eventAction:t,eventLabel:n,eventValue:r};ga&&(ga("A.send",i),ga("B.send",i),ga("C.send",i))},sendPageview:function(e,t){var n={hitType:"pageview"};e&&(n.page=e),t&&(n.title=t),ga&&(ga("A.send",n),ga("B.send",n),ga("C.send",n))}}}),define("report/config",[],function(){var e="http://gis-gfw.wri.org/arcgis/rest/services/Utilities/Geometry/GeometryServer",t="http://gis-gfw.wri.org/arcgis/rest/services/commodities/FORMA50_2014/ImageServer",n="http://gis-gfw.wri.org/arcgis/rest/services/GFW/analysis/ImageServer",r="http://gis-potico.wri.org/arcgis/rest/services/suitabilitymapper/kpss_mosaic/ImageServer",i="http://gis-potico.wri.org/arcgis/rest/services/Fires/Global_Fires/MapServer",s="http://www.wri.org/publication/how-identify-degraded-land-sustainable-palm-oil-indonesia",o="http://gis-gfw.wri.org/arcgis/rest/services/GFW/analysis_wm/ImageServer",u="http://gis.wri.org/arcgis/rest/services/CountryBoundaries/CountryBoundaries/MapServer/0",a=[1,13],f=[2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013],l=["31 - 50%","51 - 74%","75 - 100%"],c=[1,3],h=["#ccf1a5","#859a59","#4b5923"],p=[0,3],d=["#87CEEB","#00AA00","#DD0000","#8A2BE2"],v=["Primary Degraded","Primary Intact"],m=[1,2],g=["#259F1F","#186513"],y=["Convertible Production Forest","Limited Production Forest","Non-forest","Production Forest","Protected Area"],b=[1,5],w=["rgb(230, 152, 0)","rgb(116, 196, 118)","rgb(255, 255, 190)","rgb(199, 233, 192)","rgb(35, 139, 69)"],E=["Moratorium area"],S=[0,1],x=["#5fc29a"],T=["Protected Area"],N=[0,1],C=["#296eaa"],k=["0","1 - 10","11 - 20","21- 35","36 - 70","71 - 100","101 - 150","151 - 200","201 - 300","Greater than 300"],L=[0,9],A=["#fdffcc","#faeeb9","#f6ddaa","#f4ca99","#f1bc8b","#eca97a","#e89c6f","#e08b5e","#db7c54","#d56f4a"],O=["Intact Forest"],M=[0,1],_=["#186513"],D=["Peat"],P=[0,1],H=["#161D9C"],B=["Agriculture","Mixed agriculture and forest","Grassland / Shrub","Mixed forest and grassland","Non-forest","Primary Forest","Secondary Forest","Settlements","Swamp","Water Bodies"],j=[1,10],F=["#d89827","#86fc1f","#fdffb6","#b98f57","#CCC","#5fa965","#c7ffb6","#fca0bf","#538996","#65a2f8"],I=["Agriculture","Agroforestry","Fish pond","Grassland / Shrub","Mining","Oil Palm Plantation","Primary Forest","Rubber Plantation","Secondary Forest","Settlements","Swamp","Timber Plantation","Water Bodies"],q=[1,13],R=["#d89827","#26fc79","#b1e3fc","#fdffb6","#000","#d89827","#5fa965","#eeb368","#c7ffb6","#fca0bf","#538996","#745b37","#65a2f8"],U=["Agriculture","Estate crop plantation","Fish pond","Grassland / Shrub","Mining","Primary Forest","Secondary Forest","Settlements","Swamp","Timber Plantation","Water Bodies"],z=[1,11],W=["#d89827","#eeb368","#b1e3fc","#fdffb6","#000","#5fa965","#c7ffb6","#fca0bf","#538996","#745b37","#65a2f8"];return{corsEnabledServers:["http://gis-potico.wri.org","http://175.41.139.43","http://54.164.126.73","http://46.137.239.227","https://gfw-fires.wri.org","http://gis-gfw.wri.org"],boundariesUrl:u,printUrl:"http://gis-potico.wri.org/arcgis/rest/services/Utilities/PrintingTools/GPServer/Export%20Web%20Map%20Task/execute",alertUrl:{forma:"http://gfw-apis.appspot.com/subscribe",fires:"https://gfw-fires.wri.org/subscribe_by_polygon"},millPointInfo:{concession:{title:"Concession Analysis",content:"A risk assessment for concession areas within a 50km sourcing radius of a palm oil mill."},radius:{title:"Radius Analysis",content:"A risk assessment for the entire area within a 50km sourcing radius around a palm oil mill."}},geometryServiceUrl:e,imageServiceUrl:n,clearanceAnalysisUrl:o,totalLoss:{rasterId:"$521",bounds:a,labels:f},clearanceAlerts:{rasterId:"$2"},millPoints:{url:"http://update.risk-api.appspot.com/",title:"Palm Oil Mill Risk Assessment",rootNode:"millPoints"},suitability:{url:r,title:"Suitability",rootNode:"suitabilityAnalysis",rasterFunction:"PalmOilSuitability_Histogram",geometryType:"esriGeometryPolygon",lcHistogram:{renderRule:{rasterFunction:"lc_histogram",rasterFunctionArguments:{LCRaster:"$12",LCInpR:[0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8],LCOutV:[0,1,2,3,4,5,6,7,8]}},renderRuleSuitable:{rasterFunction:"classify_suitability",rasterFunctionArguments:{TargetRaster:"$12",InpTarget:[0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8],OutVTarget:[0,1,2,3,4,5,6,7,8]}},classIndices:{convertible:[1],production:[2,4],other:[3]}},roadHisto:{mosaicRule:{mosaicMethod:"esriMosaicLockRaster",lockRasterIds:[14],ascending:!0,mosaicOperation:"MT_FIRST"},className:"ROAD_DISTANCE_KM"},concessions:{url:"http://gis-potico.wri.org/arcgis/rest/services/CommoditiesAnalyzer/moremaps2_EN/MapServer",layer:"10"},localRights:{content:"Local rights/interests:  Unknown.  To be determined through field assessments.",fieldAssessmentUrl:s,fieldAssessmentLabel:"Learn about field assessments."},chart:{title:"Suitability by Legal Classification",suitable:{color:"#461D7C",name:"Suitable",id:"donut-Suitable"},unsuitable:{color:"#FDD023",name:"Unsuitable",id:"donut-Unsuitable"},childrenLabels:["HP/HPT","HPK","APL"],childrenColors:["#74C476","#E69800","#FFFFBE"]}},clearanceBounds:{url:t,baseYearLabel:14},rspo:{rootNode:"rspoData",title:"RSPO Land Use Change Analysis",rasterId:"$5",bounds:p,lossBounds:[5,13],colors:d},primaryForest:{rootNode:"primaryForest",title:"Primary Forests - Indonesia",rasterId:"$519",formaId:"$11",bounds:m,labels:v,clearanceChart:{title:"Clearance Alerts in Primary Forests since Jan 2013",type:"pie"},lossChart:{title:"Annual Tree Cover Loss (in hectares) in Primary Forests",removeBelowYear:2005},compositionAnalysis:{rasterId:519,histogramSlice:1},colors:g,fireKey:"primaryForest"},treeCover:{rootNode:"treeCoverDensity",title:"Tree Cover Density",rasterId:"$520",formaId:"$12",includeFormaIdInRemap:!0,rasterRemap:{rasterFunction:"Remap",rasterFunctionArguments:{InputRanges:[31,51,51,75,75,101],OutputValues:[1,2,3],Raster:"$520",AllowUnmatched:!1}},bounds:c,labels:l,clearanceChart:{title:"Clearance Alerts on Tree Cover Density since Jan 2013",type:"pie"},lossChart:{title:"Annual Tree Cover Loss (in hectares) on Tree Cover Density"},compositionAnalysis:{title:"Tree Cover Density (30%-100%)",rasterId:520,histogramSlice:31},colors:h,fireKey:"treeCover",errors:{composition:"No Tree Cover Density greater than 30% detected in this area."}},treeCoverLoss:{rootNode:"treeCoverLoss",title:"Tree Cover Loss",rasterId:"$517",mosaicRule:{mosaicMethod:"esriMosaicLockRaster",lockRasterIds:[521],ascending:!0,mosaicOperation:"MT_FIRST"},lossChart:{title:"Annual Tree Cover Loss (in hectares)"},compositionAnalysis:{rasterId:521,histogramSlice:1},bounds:c,color:"#DB6598",labels:[]},legalClass:{rootNode:"legalClasses",title:"Legal Classifications",rasterId:"$7",bounds:b,labels:y,clearanceChart:{title:"Clearance Alerts on Legal Classifications since Jan 2013",type:"pie"},lossChart:{title:"Annual Tree Cover Loss (in hectares) on Legal Classifications",removeBelowYear:2005},colors:w,fireKey:"legalClass"},indonesiaMoratorium:{rootNode:"indoMoratorium",title:"Indonesia Moratorium",rasterId:"$522",formaId:"$14",bounds:S,labels:E,clearanceChart:{title:"Clearance alerts on Moratorium Areas since Jan 2013",type:"bar"},lossChart:{title:"Annual Tree Cover Loss (in hectares) on Indonesia Moratorium",removeBelowYear:2011},colors:x,fireKey:"indonesiaMoratorium",compositionAnalysis:{rasterId:522,histogramSlice:1}},protectedArea:{rootNode:"protectedAreas",title:"Protected Areas",rasterId:"$10",bounds:N,labels:T,clearanceChart:{title:"Clearance Alerts on Protected Areas since Jan 2013",type:"bar"},lossChart:{title:"Annual Tree Cover Loss (in hectares) on Protected Areas"},compositionAnalysis:{rasterId:10,histogramSlice:1},colors:C,fireKey:"protectedArea",errors:{composition:"No protected areas detected in this area."}},carbonStock:{rootNode:"carbonStocks",title:"Forest Carbon Stocks",rasterId:"$1",bounds:L,labels:k,clearanceChart:{title:"Clearance Alerts on Forest Carbon Stocks since Jan 2013",type:"pie"},lossChart:{title:"Annual Tree Cover Loss (in hectares) on Forest Carbon Stocks (Mg C /Ha)",removeBelowYear:2005},colors:A,fireKey:"carbonStock"},intactForest:{rootNode:"intactForestLandscape",title:"Intact Forest Landscapes",rasterId:"$9",bounds:M,labels:O,clearanceChart:{title:"Clearance Alerts on Intact Forest Landscapes since Jan 2013",type:"bar"},lossChart:{title:"Annual Tree Cover Loss (in hectares) on Intact Forest Landscapes"},colors:_,fireKey:"intactForest",errors:{composition:"No intact forest landscapes data available in this area."}},peatLands:{rootNode:"peatLands",title:"Peat Lands",rasterId:"$8",bounds:P,labels:D,clearanceChart:{title:"Clearance Alerts on Peat Lands since Jan 2013",type:"bar"},lossChart:{title:"Annual Tree Cover Loss (in hectares) on Peat Lands",removeBelowYear:2002},compositionAnalysis:{rasterId:8,histogramSlice:1},colors:H,fireKey:"peatLands",errors:{composition:"Np peat land detected in this area according to indonesia peat data."}},landCoverGlobal:{rootNode:"globalLandCover",title:"Land Cover - Global",rasterId:"$3",bounds:j,labels:B,clearanceChart:{title:"Clearance Alerts on Land Cover - Global since Jan 2013",type:"pie"},lossChart:{title:"Annual Tree Cover Loss (in hectares) on Land Cover - Global",removeBelowYear:2004},colors:F,fireKey:"landCoverGlobal"},landCoverAsia:{rootNode:"asiaLandCover",title:"Land Cover - Southeast Asia",rasterId:"$4",bounds:q,labels:I,clearanceChart:{title:"Clearance Alerts on Land Cover - Southeast Asia since Jan 2013",type:"pie"},lossChart:{title:"Annual Tree Cover Loss (in hectares) on Land Cover - Southeast Asia",removeBelowYear:2005},colors:R,fireKey:"landCoverAsia"},landCoverIndo:{rootNode:"indoLandCover",title:"Land Cover - Indonesia",rasterId:"$6",bounds:z,labels:U,clearanceChart:{title:"Clearance Alerts on Land Cover - Indonesia since Jan 2013",type:"pie"},lossChart:{title:"Annual Tree Cover Loss (in hectares) on Land Cover - Indonesia",removeBelowYear:2006},colors:W,fireKey:"landCoverIndo"},fires:{url:i,primaryForest:{type:"pie",field:"primary_fo",labels:v,bounds:m,colors:g,title:"Active Fires in Primary Forests over the past 7 days",badgeDesc:"in primary forests out of"},treeCover:{type:"pie",field:"treecover",labels:l,bounds:[1,5],colors:h,title:"Active Fires by Tree Cover Density over the past 7 days",badgeDesc:"on tree cover density out of"},legalClass:{type:"pie",field:"legal",labels:y,bounds:b,colors:w,title:"Active Fires by Legal Classifications over the past 7 days",badgeDesc:"on legal classes out of"},carbonStock:{type:"pie",field:"carbon",labels:k,bounds:L,colors:A,title:"Active Fires by Forest Carbon Stocks over the past 7 days",badgeDesc:"on forest carbon stocks out of"},protectedArea:{type:"badge",field:"wdpa",badgeDesc:"in protected areas out of"},intactForest:{type:"badge",field:"ifl",badgeDesc:"on intact forest landscapes out of"},peatLands:{type:"badge",field:"peat",badgeDesc:"on peat lands out of"},landCoverGlobal:{type:"pie",field:"lc_global",labels:B,bounds:j,colors:F,title:"Active Fires by Land Cover - Global over the past 7 days",badgeDesc:"on land cover global out of"},landCoverAsia:{type:"pie",field:"lc_seasia",labels:I,bounds:q,colors:R,title:"Active Fires by Land Cover - Southeast Asia over the past 7 days",badgeDesc:"on land cover southeast asia out of"},landCoverIndo:{type:"pie",field:"lc_ind",labels:U,bounds:z,colors:W,title:"Active Fires by Land Cover - Indonesia over the past 7 days",badgeDesc:"on land cover indonesia out of"},indonesiaMoratorium:{type:"badge",field:"moratorium",badgeDesc:"on indonesia moratorium out of"}}}}),define("report/CSVExporter",["dojo/_base/array"],function(e){"use strict";function t(e){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",n,r,i,s,o,u,a,f,l=0,c=0,h="",p=[];if(!e)return e;do n=e.charCodeAt(l++),r=e.charCodeAt(l++),i=e.charCodeAt(l++),f=n<<16|r<<8|i,s=f>>18&63,o=f>>12&63,u=f>>6&63,a=f&63,p[c++]=t.charAt(s)+t.charAt(o)+t.charAt(u)+t.charAt(a);while(l<e.length);h=p.join("");var d=e.length%3;return(d?h.slice(0,d-3):h)+"===".slice(d||3)}function n(e,t){t=t||"";var n=1024,r=atob(e),i=r.length,s=Math.ceil(i/n),o=new Array(s);for(var u=0;u<s;++u){var a=u*n,f=Math.min(a+n,i),l=new Array(f-a),c=0;for(var h=a;h<f;++c,++h)l[c]=r[h].charCodeAt(0);o[u]=new Uint8Array(l)}return new Blob(o,{type:t})}function r(t){var n=t.series,r=[],i=[];return e.forEach(n[0].data,function(e){i.push(e.category)}),r.push("Suitability,"+i.join(",")),e.forEach(n,function(t){i=[],i.push(t.name),e.forEach(t.data,function(e){i.push(Math.abs(e.y.toFixed(2)))}),r.push(i.join(","))}),r}function i(t){var n=t.series,r=[],i=[],s;return s=t.xAxis[0].categories,e.forEach(s,function(e){i.push(e)}),r.push("Type,"+i.join(",")),e.forEach(n,function(t){i=[],i.push(t.name),e.forEach(t.data,function(e){i.push(e.y)}),r.push(i.join(","))}),r}function s(t){var n=["Unsuitable"],r=["Suitable"],i=t.series,s=0,o=0,u=0,a=0,f=0,l=0,c=[],h=[],p;return c.push("Suitability,Total,HP/HPT,HPK,APL"),p=i[0],e.forEach(p.data,function(e){e.name==="Suitable"?r.push(e.y):n.push(e.y)}),p=i[1],e.forEach(p.data,function(e){switch(e.name){case"HP/HPT":e.parentId==="donut-Suitable"?a=e.y||0:s=e.y||0;break;case"APL":e.parentId==="donut-Suitable"?l=e.y||0:u=e.y||0;break;case"HPK":e.parentId==="donut-Suitable"?f=e.y||0:o=e.y||0}}),r=r.concat([a,f,l]),n=n.concat([s,o,u]),c.push(r.join(",")),c.push(n.join(",")),c}function o(){var t=document.getElementById("title").innerHTML,n=$("#suitabilityAnalysis_content tr"),r=[],i;return r.push("Suitability Statistics"),r.push(t),r.push("Parameter, Value"),e.forEach(n,function(e){i=e.cells[1].innerHTML.replace(",",""),r.push(e.cells[0].innerHTML+","+i)}),r}var u={exportCSV:function(e){var r="data:application/vnd.ms-excel;base64,",i="text/csv;charset=utf-8",s="data.csv",o=document.createElement("a"),u;saveAs&&!!(new Blob)?(u=n(t(e),i),saveAs(u,s)):o.download===""?(o.href=r+t(e),o.target="_blank",o.download=s,o.click()):window.open(r+t(e))},exportSuitabilityByLegalClass:s,exportSuitabilityStatistics:o,exportCompositionAnalysis:r,exportSimpleChartAnalysis:i};return u}),define("report/Renderer",["report/config","dojo/number","dijit/Dialog","dojo/_base/array","dojo/on","dojo/dom","dojo/dom-style","report/CSVExporter","utils/Analytics"],function(e,t,n,r,i,s,o,u,a){"use strict";var f="url(../../css/images/download-icon.svg)";return{renderContainers:function(e){var t=document.createDocumentFragment(),n=document.createElement("div"),r=document.getElementById("print-map");n.id=e.rootNode,n.className="result-container",n.innerHTML="<div class='title'>"+e.title+"</div>"+"<div class='result-block total-loss'>"+"<div class='top-panel' id='"+e.rootNode+"_composition'></div>"+"<div class='left-panel'>"+"<div class='loss-chart' id='"+e.rootNode+"_loss'><div class='loader-wheel'>total loss</div></div>"+"</div>"+"<div class='right-panel'>"+"<div class='fires-chart' id='"+e.rootNode+"_fire'><div class='loader-wheel'>active fires</div></div>"+"</div>"+"</div>"+"<div class='result-block clearance-alerts'>"+"<div class='clearance-chart' id='"+e.rootNode+"_clearance'><div class='loader-wheel'>clearance alerts</div></div>"+"</div>"+"<div class='result-block mill-points'>"+"<div class='mill-table' id='"+e.rootNode+"_mill'></div>"+"</div>",t.appendChild(n),document.getElementById("report-results-section").insertBefore(t,r)},renderTotalLossContainer:function(e){var t=document.createDocumentFragment(),n=document.createElement("div"),r=document.getElementById("print-map");n.id=e.rootNode,n.className="result-container",n.innerHTML="<div class='title'>"+e.title+"</div>"+"<div class='result-block total-loss'>"+"<div class='top-panel' id='"+e.rootNode+"_composition'></div>"+"<div class='left-panel'>"+"<div class='loss-chart' id='"+e.rootNode+"_loss'><div class='loader-wheel'>total loss</div></div>"+"</div>"+"</div>",t.appendChild(n),document.getElementById("report-results-section").insertBefore(t,r)},renderRSPOContainer:function(e){var t=document.createDocumentFragment(),n=document.createElement("div"),r=document.getElementById("print-map");n.id=e.rootNode,n.className="result-container",n.innerHTML="<div class='title'>"+e.title+"</div>"+"<div class='rspo-table-container' id='"+e.rootNode+"_table'><div class='loader-wheel'>rspo analysis</div></div>"+"<div class='rspo-chart-container' id='"+e.rootNode+"_chart'></div>",t.appendChild(n),document.getElementById("report-results-section").insertBefore(t,r)},renderSuitabilityContainer:function(e){var t=document.createDocumentFragment(),n=document.createElement("div"),r=document.getElementById("print-map");n.id=e.rootNode,n.className="result-container",n.innerHTML="<div class='title'>"+e.title+"</div>"+"<div class='suitability-container'>"+"<div class='left-panel'>"+"<div id='suitability-table-csv' class='csv-download' title='Download CSV'></div>"+"<div id='"+e.rootNode+"_content' class='suitability-content'><div class='loader-wheel'>suitability</div></div>"+"</div>"+"<div class='right-panel'>"+"<div id='"+e.rootNode+"_chart' class='suitability-chart'><div class='loader-wheel'>suitability</div></div>"+"</div>"+"<div class='clearFix'></div>"+"<div class='left-panel'>"+"<div class='suitability-settings-table-header'>Suitability Settings</div>"+"<div id='suitability-settings-csv' class='csv-download' title='Download CSV'></div>"+"<div id='suitability-settings-table'></div>"+"</div>"+"<div class='right-panel'>"+"<div id='suitability-composition-analysis'></div>"+"</div>"+"</div>",t.appendChild(n),document.getElementById("report-results-section").insertBefore(t,r)},renderMillContainer:function(e){var t=document.createDocumentFragment(),n=document.createElement("div"),r=document.getElementById("print-map");n.id=e.rootNode,n.className="result-container relative",n.innerHTML="<div class='title'>"+e.title+"</div>"+"<div class='mill-table-container' id='"+e.rootNode+"_table'><div class='loader-wheel'>risk assessment</div></div>",t.appendChild(n),document.getElementById("report-results-section").insertBefore(t,r)},renderCompositionAnalysisLoader:function(e){document.getElementById(e.rootNode+"_composition").innerHTML='<div class="loader-wheel">composition analysis</div>'},renderCompositionAnalysis:function(e,n,r){var i=document.createDocumentFragment(),s=document.createElement("div"),o=document.getElementById(r.rootNode+"_composition"),u=r.compositionAnalysis,a=u.title||r.title,f,l,c;u.histogramSlice&&(c=e.slice(u.histogramSlice));if(c.length===0){this.renderAsUnavailable("composition",r);return}c=c.reduce(function(e,t){return e+t})*n*n/1e4,f=t.format(c),report.areaPromise.then(function(){l=t.format(c/report.area*100,{places:0}),s.className="composition-analysis-container",s.innerHTML="<div>Total "+a+" in selected area: "+f+" ha</div>"+"<div>Percent of total area comprised of "+a+": "+l+"%</div>",i.appendChild(s),o.innerHTML="",o.appendChild(i)})},renderLossData:function(t,n,i,s,o){var u=e.totalLoss,a=i.labels,l=u.labels,c=i.bounds.fromBounds(),h=u.bounds.fromBounds(),p=function(e){return e*n*n/1e4},d=[],v=[],m,g,y,b,w;if(o){y=t.slice(1).map(p);if(y.length!==l.length)for(var E=0;E<l.length;E++)y[E]===undefined&&(y[E]=0);d.push({name:a[0],data:y}),v.push(i.colors[0])}else for(b=0;b<c.length;b++){y=[];for(w=0;w<h.length;w++)m=s.encode(h[w],c[b]),y.push(t[m]||0);d.push({name:a[b],data:y.map(p)}),v.push(i.colors[b])}i.lossChart.removeBelowYear&&(g=l.indexOf(i.lossChart.removeBelowYear),l=l.slice(g),r.forEach(d,function(e){e.data=e.data.slice(g)})),$("#"+i.rootNode+"_loss").highcharts({chart:{plotBackgroundColor:null,plotBorderWidth:null,plotShadow:null,type:"bar",events:{load:function(){}}},colors:v,title:{text:i.lossChart.title},exporting:{buttons:{contextButton:{enabled:!1},exportButton:{menuItems:Highcharts.getOptions().exporting.buttons.contextButton.menuItems,symbol:f}}},xAxis:{categories:l,maxPadding:.35,title:{text:null}},yAxis:{stackLabels:{enabled:!0},title:{text:null}},legend:{enabled:!0,verticalAlign:"bottom"},plotOptions:{series:{stacking:"normal"}},series:d,credits:{enabled:!1}})},renderTreeCoverLossData:function(t,n,i){var s=e.totalLoss,o=i.labels,u=s.labels,a=i.bounds.fromBounds(),l=s.bounds.fromBounds(),c=function(e){return e*n*n/1e4},h=[],p=[],d,v,m,g,y;h.push({name:o[0],data:t.slice(1).map(c)}),p.push(i.color),i.lossChart.removeBelowYear&&(v=u.indexOf(i.lossChart.removeBelowYear),u=u.slice(v),r.forEach(h,function(e){e.data=e.data.slice(v)}));if(h[0].data.length!==u.length)for(var b=0;b<u.length;b++)h[0].data[b]===undefined&&(h[0].data[b]=0);$("#"+i.rootNode+"_loss").highcharts({chart:{plotBackgroundColor:null,plotBorderWidth:null,plotShadow:null,type:"bar",events:{load:function(){}}},exporting:{buttons:{contextButton:{enabled:!1},exportButton:{menuItems:Highcharts.getOptions().exporting.buttons.contextButton.menuItems,symbol:f}}},colors:p,title:{text:i.lossChart.title},xAxis:{categories:u,maxPadding:.35,title:{text:null}},yAxis:{stackLabels:{enabled:!0},title:{text:null}},legend:{enabled:!1,verticalAlign:"bottom"},plotOptions:{series:{stacking:"normal"}},series:h,credits:{enabled:!1}})},renderClearanceData:function(e,t,n,r,i){var s=n.labels,o=n.bounds.fromBounds(),u=report.clearanceBounds.fromBounds(),a=[],l=[],c,h,p,d;if(n.clearanceChart.type==="pie"){for(p=0;p<o.length;p++){h=0,l=[];for(d=0;d<u.length;d++)c=r.encode(u[d],o[p]),l.push(e[c]||0);a.push({name:s[p],data:l})}$("#"+n.rootNode+"_clearance").highcharts({chart:{plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1},exporting:{buttons:{contextButton:{enabled:!1},exportButton:{menuItems:Highcharts.getOptions().exporting.buttons.contextButton.menuItems,symbol:f}}},colors:n.colors,title:{text:n.clearanceChart.title},xAxis:{categories:report.clearanceLabels},yAxis:{title:null,min:0},legend:{enabled:!0},credits:{enabled:!1},series:a})}else{if(i){a=e.slice(1);if(a.length!==u.length)for(var v=0;v<u.length;v++)a[v]===undefined&&(a[v]=0)}else for(p=0;p<u.length;p++){h=0;for(d=0;d<o.length;d++)c=r.encode(u[p],o[d]),h+=e[c]||0;a.push(h)}$("#"+n.rootNode+"_clearance").highcharts({chart:{plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1},exporting:{buttons:{contextButton:{enabled:!1},exportButton:{menuItems:Highcharts.getOptions().exporting.buttons.contextButton.menuItems,symbol:f}}},colors:["#fb00b3"],title:{text:n.clearanceChart.title},xAxis:{categories:report.clearanceLabels},yAxis:{title:null,min:0},legend:{enabled:!1},credits:{enabled:!1},series:[{name:n.title,data:a}]})}},renderFireData:function(n,i){function h(e,n,r,i){var s=document.createDocumentFragment(),o=document.createElement("div"),u=document.getElementById(e+"_fire");o.className="active-fires-badge",o.innerHTML="<div>There are currently</div><div class='active-fires-label'><div>"+t.format(n)+"</div>"+"<span>active fires</span>"+"</div>"+"<div>"+i+"</div>"+"<div class='total-active-fires-label'><span>"+t.format(r)+" total active fires</span></div>",s.appendChild(o),u.innerHTML="",u.appendChild(s)}function p(e,n,r,i,s){var o=document.createDocumentFragment(),u=document.createElement("div"),a=document.getElementById(e+"_fire"),f=[];for(var l=0;l<n.length;l++)l>=r[0]&&l<=r[1]&&f.push(n[l]);u.className="active-fires-badge special",u.innerHTML="<div>Active fires are detected in:</div><div class='active-fires-label'><span>"+i[0]+" Forests</span>"+"<div>"+t.format(f[0]||0)+"</div>"+"</div>"+"<div class='active-fires-label'>"+"<span>"+i[1]+" Forests</span>"+"<div>"+t.format(f[1]||0)+"</div>"+"</div>"+"<div class='total-active-fires-label'><span>out of "+t.format(s)+" total active fires</span></div>"+"</div>",o.appendChild(u),a.innerHTML="",a.appendChild(o)}function d(e,t,n,r,i,o,u){var a=[],l=0,c=[],d;for(d=0;d<t.length;d++)d>=i[0]&&d<=i[1]&&(t[d]!==0&&!isNaN(t[d])&&(a.push([n[l],t[d]]),c.push(r[l])),l++);a.length===0?h(e,0,0,u):n.length===2?p(e,t,i,n,s.length):$("#"+e+"_fire").highcharts({chart:{plotBackgroundColor:null,plotBorderWidth:null,plotShadow:null},colors:c,title:{text:"Active Fires"},exporting:{buttons:{contextButton:{enabled:!1},exportButton:{menuItems:Highcharts.getOptions().exporting.buttons.contextButton.menuItems,symbol:f}}},plotOptions:{pie:{size:"75%",allowPointSelect:!0,cursor:"pointer",showInLegend:!0,dataLabels:{enabled:!1}}},credits:{enabled:!0},legend:{enabled:!1},series:[{type:"pie",name:"Fires",data:a}]})}var s=i[0].features,o,u,a,l,c;r.forEach(n,function(t){a=t.rootNode,l=e.fires[t.fireKey];if(i.length>1&&t.fireKey==="indonesiaMoratorium"){var n=0;r.forEach(i[1].features,function(e){n+=+e.attributes[l.field]}),h(a,n,s.length,l.badgeDesc);return}if(s.length===0)h(a,0,0,l.badgeDesc);else if(l.type==="pie"){u=[];for(c=0;c<=l.labels.length;c++)u[c]=0;r.forEach(s,function(e){u[e.attributes[l.field]]++}),d(a,u,l.labels,l.colors,l.bounds,l.title,l.badgeDesc)}else o=0,r.forEach(s,function(e){o+=isNaN(parseInt(e.attributes[l.field]))?0:parseInt(e.attributes[l.field])}),h(a,o,s.length,l.badgeDesc)})},renderRSPOData:function(n,i,s){var o=e.rspo.lossBounds.fromBounds(),f=this;if(!(n.histograms.length>0)){document.getElementById(i.rootNode+"_table").innerHTML="<div class='data-not-available'>No RSPO Data Available for this Site.</div>";return}var l=2005,c=8,h="",p="",d="",v="",m="",g=[],y=[],b=[],w=[],E=[],S,x,T,N,C;h="<div id='rspo-table-csv' class='csv-download' title='Download CSV'></div><table class='rspo-results-table'><tr><th>Forest Type</th>";for(T=0;T<=c;T++)g.push(l+T),h+="<th>"+(l+T)+"</th>";h+="</tr>",x=n.histograms[0].counts;for(N=0;N<o.length;N++)S=s.encode(o[N],2),b.push(x[S]||0),S=s.encode(o[N],3),w.push(x[S]||0),S=s.encode(o[N],1),y.push(x[S]||0),S=s.encode(o[N],0),E.push(x[S]||0);d="<tr><td>Primary</td>",v="<tr><td>Secondary</td>",p="<tr><td>Agroforestry</td>",m="<tr><td>Non-Forest</td>";for(C=0;C<b.length;C++)d+="<td>"+(t.format(b[C])||0)+"</td>",v+="<td>"+(t.format(w[C])||0)+"</td>",p+="<td>"+(t.format(y[C])||0)+"</td>",m+="<td>"+(t.format(E[C])||0)+"</td>";d+="</tr>",v+="</tr>",p+="</tr>",m+="</tr>",h+=d+v+p+m+"</table>",h+="<div class='change-area-unit'>(Change in Hectares)</div>",document.getElementById(i.rootNode+"_table").innerHTML=h,this.renderRSPOChart(i,b,w,y,E,g),$("#rspo-table-csv").click(function(){var e="\r\n",t=[],n=[],i="";t.push("RSPO Land Use Change Analysis"),t.push(document.getElementById("title").innerHTML),r.forEach(g,function(e){n.push(e)}),t.push("Forest Type,"+n.join(",")),n=[],r.forEach(b,function(e){n.push(e)}),t.push("Primary,"+n.join(",")),n=[],r.forEach(w,function(e){n.push(e)}),t.push("Secondary,"+n.join(",")),n=[],r.forEach(y,function(e){n.push(e)}),t.push("Agroforestry,"+n.join(",")),n=[],r.forEach(E,function(e){n.push(e)}),t.push("Non-Forest,"+n.join(",")),i=t.join(e),u.exportCSV(i),a.sendEvent("Event","click","Download CSV","User downloaded RSPO results table.")})},renderRSPOChart:function(e,n,r,i,s,o){var u={color:"#000"},a={style:u};$("#"+e.rootNode+"_chart").highcharts({chart:{backgroundColor:"#FFF",type:"column"},exporting:{buttons:{contextButton:{enabled:!1},exportButton:{menuItems:Highcharts.getOptions().exporting.buttons.contextButton.menuItems,symbol:f}}},colors:e.colors,title:{text:null},legend:{align:"center",verticalAlign:"top",enabled:!0},xAxis:{categories:o,labels:a},yAxis:{title:{text:"",style:u},labels:a},plotOptions:{column:{stacking:"normal"}},tooltip:{formatter:function(){return"<strong>"+this.key+"</strong><br/>"+this.series.name+": "+t.format(this.y)+"<br/>"+"Total: "+t.format(this.point.stackTotal)}},credits:{enabled:!1},series:[{name:"Primary",data:n},{name:"Secondary",data:r},{name:"Agroforestry",data:i},{name:"Non-Forest",data:s}]})},renderSuitabilityData:function(e,n){var r=e.lcHistogram.classIndices,i="<table>",s,o,u,a,f,l,c,h,p,d;d=n[0],d?(s=Math.pow(d.pixelSize/100,2),d.data.counts[1]?(u=t.format(d.data.counts[1]*s)||d.data.counts[1],o=t.format(d.data.counts[0]*s)||d.data.counts[0]):(u=0,o=t.format(d.data.counts[0]*s))):(u="N/A",o="N/A"),d=n[1];if(d){s=Math.pow(d.pixelSize/100,2);var v=function(e){var n=0;for(var r=0;r<e.length;r++)d.data.counts[e[r]]&&(n+=d.data.counts[e[r]]*s);return t.format(n)};c=v(r.production),h=v(r.convertible),p=v(r.other)}else c="N/A",h="N/A",p="N/A";d=n[2],d?f=parseFloat(d.data.min/1e3).toFixed(1):f="N/A",d=n[3],d?l=d.value:l="N/A",i+="<tr><td>Suitable(ha):</td><td>"+u+"</td></tr>",i+="<tr><td>Unsuitable(ha):</td><td>"+o+"</td></tr>",i+="<tr><td>Distance to nearest road(km):</td><td>"+f+"</td></tr>",i+="<tr><td>Existing concessions(Yes/No):</td><td>"+l+"</td></tr>",i+="<tr><td>Legal Classification(ha):</td><td></td></tr>",i+="<tr><td class='child-row'>Production forest(HP/HPT):</td><td>"+c+"</td></tr>",i+="<tr><td class='child-row'>Convertible forest(HPK):</td><td>"+h+"</td></tr>",i+="<tr><td class='child-row'>Other land uses(APL):</td><td>"+p+"</td></tr>",i+="</table>",i+="<p>"+e.localRights.content+"</p>",i+="<div class='field-assessment-link'><a href='"+e.localRights.fieldAssessmentUrl+"'>"+e.localRights.fieldAssessmentLabel+"</a>"+"</div>",document.getElementById(e.rootNode+"_content").innerHTML=i,this.renderSuitabilityChart(e,n[4]),this.renderSuitabilitySettingsTable()},renderSuitabilitySettingsTable:function(){var e=payload&&payload.suitability&&payload.suitability.csv,t="<table><thead><tr>",n,i,s,o,u,a;e&&(s=e.split("\n"),n=s.splice(1),i=s[0].split(","),t+="<th>Parameter</th><th>Setting</th></tr></thead><tbody>",r.forEach(n,function(e){a=e.split(","),o=a[0],u=a[1],o!==undefined&&o!==""&&(t+="<tr><td>"+o+"</td><td>"+u.replace(/\;/g,",")+"</td></tr>")}),t+="</tbody></table>",$("#suitability-settings-table").html(t))},renderSuitabilityCompositionChart:function(e){var t=[],n=[],i=[],s;r.forEach(e,function(e){s=e.suitable+e.unsuitable,e.suitable=e.suitable/s*100,e.unsuitable=e.unsuitable/s*100*-1}),e.sort(function(e,t){return e.suitable>t.suitable?1:t.suitable>e.suitable?-1:0}),r.forEach(e,function(e){t.push(e.unsuitable),n.push(e.suitable),i.push(e.label)}),$("#suitability-composition-analysis").highcharts({chart:{type:"bar"},title:{text:"Suitability Composition Analysis"},colors:["#FDD023","#461D7C"],credits:{enabled:!1},xAxis:[{categories:i,reversed:!1},{labels:{enabled:!1},opposite:!0,reversed:!1,linkedTo:0,tickLength:0}],yAxis:{title:{text:null},min:-100,max:100,labels:{formatter:function(){return Math.abs(this.value)+(this.value!==0?"%":"")}}},tooltip:{formatter:function(){return"<b>"+this.point.category+"</b><br/>"+"<b>"+this.series.name+":</b>	"+Highcharts.numberFormat(Math.abs(this.point.y),2)+"%"}},plotOptions:{series:{stacking:"normal"}},series:[{name:"Unsuitable",data:t},{name:"Suitable",data:n}],exporting:{buttons:{contextButton:{enabled:!1},exportButton:{menuItems:Highcharts.getOptions().exporting.buttons.contextButton.menuItems,symbol:f}}}})},renderSuitabilityChart:function(e,t){function h(e){var n={suitable:0,unsuitable:0};for(var i=0;i<e.length;i++)t.data.counts[e[i]]&&(n.unsuitable+=t.data.counts[e[i]]*r,n.suitable+=t.data.counts[e[i]+10]*r);return n}if(!t){document.getElementById(e.rootNode+"_chart").innerHTML="<div class='data-not-available'>No Suitability Data Available to chart for this Site.</div>";return}var n=e.lcHistogram.classIndices,r=Math.pow(t.pixelSize/100,2),i=e.chart,s=[],o=[],u=[],a,l,c;a=h(n.convertible),l=h(n.production),c=h(n.other),s.push({y:a.suitable+l.suitable+c.suitable,color:i.suitable.color,name:i.suitable.name,id:i.suitable.id,children:{categories:i.childrenLabels,colors:i.childrenColors,data:[l.suitable,a.suitable,c.suitable]}}),s.push({y:a.unsuitable+l.unsuitable+c.unsuitable,color:i.unsuitable.color,name:i.unsuitable.name,id:i.unsuitable.id,children:{categories:i.childrenLabels,colors:i.childrenColors,data:[l.unsuitable,a.unsuitable,c.unsuitable]}});for(var p=0;p<s.length;p++)if(s[p].y>0){o.push({color:s[p].color,name:s[p].name,id:s[p].id,y:s[p].y});for(var d=0;d<s[p].children.data.length;d++)s[p].children.data[d]>0&&u.push({name:s[p].children.categories[d],color:s[p].children.colors[d],y:s[p].children.data[d],parentId:s[p].id})}$("#"+e.rootNode+"_chart").highcharts({chart:{type:"pie",backgroundColor:"#FFF",plotBorderWidth:null},title:{text:i.title},tooltip:{valueSuffix:""},exporting:{buttons:{contextButton:{enabled:!1},exportButton:{menuItems:Highcharts.getOptions().exporting.buttons.contextButton.menuItems,symbol:f}}},plotOptions:{series:{point:{events:{legendItemClick:function(){var e=this.id,t=this.series.chart.series[1].data;t.forEach(function(t){t.parentId===e&&(t.visible?t.setVisible(!1):t.setVisible(!0))})}}}}},legend:{itemStyle:{color:"#000"}},credits:{enabled:!1},series:[{name:"Area",data:o,size:"60%",showInLegend:!0,dataLabels:{enabled:!1}},{name:"Legal Area",data:u,size:"80%",innerSize:"60%",dataLabels:{color:"black",distance:5}}]})},renderMillAssessment:function(e,t){function o(e,t,n){var r="data-row"+(n?" child "+n:""),i="<tr class='"+r+"'><td class='row-name'><span>"+e+"</span></td>";return i+="<td class='"+t.concession.risk+"'><span class='large-swatch'></span><span class='risk-label'>"+t.concession.risk+"</span></td>",i+="<td class='"+t.radius.risk+"'><span class='large-swatch'></span><span class='risk-label'>"+t.radius.risk+"</span></td>",i+="</tr>",i}function u(e,t,n,r){var i="data-row parent",s="<tr class='"+i+"' data-class='"+n+"'><td class='row-name'>"+"<span class='toggle-icon'></span><span>"+e+"</span></td>";return s+="<td class='"+(t[r+"_concession"]||"N/A")+"'><span class='large-swatch'></span><span class='risk-label'>"+(t[r+"_concession"]||"N/A")+"</span></td>",s+="<td class='"+(t[r+"_radius"]||"N/A")+"'><span class='large-swatch'></span><span class='risk-label'>"+(t[r+"_radius"]||"N/A")+"</span></td>",s+="</tr>",s}function a(e,t,n){var r="<tr class='data-row'><td class='row-name'><span>"+e+"</span></td>",i=n?t[n+"_concession"]:t.concession.risk,s=n?t[n+"_radius"]:t.radius.risk;return r+="<td class='"+i+"'><span class='large-swatch'></span><span class='risk-label'>"+i+"</span></td>",r+="<td class='"+s+"'><span class='large-swatch'></span><span class='risk-label'>"+s+"</span></td>",r+="</tr>",r}function f(e){var t=e.currentTarget,n=t.dataset?t.dataset.class:t.getAttribute("data-class");$(".mill-table-container .data-row.child."+n).toggle(),$(t).toggleClass("open")}var n=[],i="",s;r.forEach(e,function(e,t){e.mill_name?s=e.mill_name:report.mills&&r.some(report.mills,function(t){if(e.id===t.millId)return s=t.label,!0}),s===undefined&&(s=window.payload.title),i="<div class='mill-header'><span class='mill-title'>"+s+"</span>"+"<span class='mill-risk-level "+e.total_mill_priority_level+"'><span class='large-swatch'></span>"+"Total Mill Priority Level: <span class='overall-risk'>"+e.total_mill_priority_level+"</span></span>"+"<span class='mill-rspo-certification'>RSPO Certification: <span>"+(e.rspo.risk?"Yes":"No")+"</span></span></div>",i+="<table><tr><th></th><th>Concession<span class='info-icon' data-type='concession'></span></th><th>Radius<span class='info-icon' data-type='radius'></span></th></tr>",i+=a("Priority Level",e,"priority_level"),i+=u("Deforestation",e.deforestation,"deforest-"+e.id,"deforestation"),i+=o("Total tree cover loss",e.deforestation.umd_loss,"deforest-"+e.id),i+=o("Tree cover loss on primary forest",e.deforestation.umd_loss_primary,"deforest-"+e.id),i+=o("Total clearance alerts",e.deforestation.forma,"deforest-"+e.id),i+=o("Clearance alerts on primary forest",e.deforestation.forma_primary,"deforest-"+e.id),i+=o("Tree cover loss on carbon stock",e.deforestation.carbon,"deforest-"+e.id),e.deforestation.area_carbon&&(i+=o("Area in high carbon density",e.deforestation.area_carbon,"deforest-"+e.id),i+=o("Alerts on high carbon density",e.deforestation.forma_carbon,"deforest-"+e.id),i+=o("Clearance alerts on primary forest/IFL",e.deforestation.forma_primary,"deforest-"+e.id)),i+=a("Legality",e.legal),i+=u("Peat",e.peat,"peat-"+e.id,"peat"),i+=o("Presence of peat",e.peat.presence,"peat-"+e.id),i+=o("Clearance on peat",e.peat.clearance,"peat-"+e.id),e.peat.alerts&&(i+=o("Clearance alerts on peat",e.peat.alerts,"peat-"+e.id)),i+=a("Fires",e.fire),i+="</table>",n.push(i)}),document.getElementById(t.rootNode+"_table").innerHTML=n.join("<br />"),$(".mill-table-container tr.parent").click(f),$(".mill-table-container .info-icon").click(this.showMillPointInfo),$(".mill-table-container .data-row.child").toggle()},showMillPointInfo:function(t){var r=t.currentTarget,i=r.dataset?r.dataset.type:r.getAttribute("data-type"),s=e.millPointInfo[i],o;o=new n({title:s.title,content:s.content,style:"width: 300px;"}),o.show()},renderAsUnavailable:function(e,t){var n=document.getElementById(t.rootNode+"_"+e),r="";e==="loss"?r="No tree cover loss detected.":e==="clearance"?r="No clearance alerts occured in this area.":e==="composition"?r=t.errors&&t.errors.composition||"No Composition Analysis Data Available for this site.":r="No Mill Point Data Available for this site.",n&&(n.innerHTML=r)}}}),define("report/riskRequests",["dojo/Deferred","esri/tasks/QueryTask","esri/tasks/query","esri/tasks/ImageServiceIdentifyTask","esri/tasks/ImageServiceIdentifyParameters","esri/tasks/StatisticDefinition","esri/request","esri/tasks/AreasAndLengthsParameters","esri/tasks/GeometryService","esri/SpatialReference","esri/tasks/ProjectParameters","esri/tasks/BufferParameters"],function(e,t,n,r,i,s,o,u,a,f,l,c){var h={},p=function(e,t){for(param in t)t.hasOwnProperty(param)&&t[param]&&(e[param]=t[param]);return e},d=function(e){return e.lengthUnit=a[e.lengthUnit],e.areaUnit=a[e.areaUnit],e},v=function(t,n,r){var i=new e;return r=r||"execute",t[r](n,function(e){i.resolve(e)},function(e){i.resolve(e)}),i};return h.getAreasLengths=function(t,n){var r=new e;n=d(n);var i=p(new u,n),s=new a(t);return s.areasAndLengths(i).then(function(e){r.resolve(e)}),r},h.project=function(t,n,r){var i=new e;n.outSR=new f(r);var s=new a(t),o=p(new l,n);return s.project(o).then(function(e){i.resolve(e)}),i},h.buffer=function(t,n,r){var i=new e,s=p(new c,n);s.unit=a[n.unit],s.spatialReference=n.geometries[0].spatialReference,s.outSpatialReference=new f(r);var o=new a(t);return o.buffer(s).then(function(e){i.resolve(e)}),i},h.loadServiceInfo=function(t){var n=new e,r=esri.request({url:t,content:{f:"json"},handleAs:"json"});return r.then(function(e){console.log("Success: ",e.layers),n.resolve(e)},function(e){console.log("Error: ",e.message),n.resolve(e)}),n},h.queryForStats=function(t,n,r){var i=new e,o=r.map(function(e){return p(new s,e)});return n.outStatistics=o,h.queryEsri(t,n)},h.queryEsri=function(e,r,i){var s=new t(e),o=p(new n,r),u=v(s,o,i);return u},h.computeHistogram=function(e,t){return o({url:e+"/computeHistograms",content:t,handleAs:"json",callbackParamName:"callback",timeout:6e4},{usePost:!0})},h.queryJson=function(){},h}),define("report/riskController",["dojo/Deferred","dojo/promise/all","dojo/_base/lang","esri/geometry/geometryEngine","esri/geometry/Polygon","report/riskRequests","report/config"],function(e,t,n,r,i,s,o){var u={},a=54012,f=102100,l=["","low","medium","high"];o.carbonDensity={rasterId:"$524"};var c={commodities:"http://gis-gfw.wri.org/arcgis/rest/services/GFW/analysis/ImageServer",fires:"http://gis-potico.wri.org/arcgis/rest/services/Fires/FIRMS_ASEAN/MapServer/0",concessions:"http://gis-gfw.wri.org/arcgis/rest/services/CommoditiesAnalyzer/moremaps2_EN/MapServer/27"},h=function(){o.treeCoverLoss.rasterId="$13",o.clearanceAlerts.rasterId="$2",o.intactForest.rasterId="$9",o.primaryForest.rasterId="$11",o.legalClass.rasterId="$7",o.protectedArea.rasterId="$10",o.peatLands.rasterId="$8",o.carbonDensity.rasterId="$15"};return u.getRiskByGeometry=function(r,i,u,a,f,h,p){var d=i,v=function(e,t,n){return n>t?3:n<=e?1:2},m=function(e,t){return function(n){if(!n.histograms[0])return 1;var r=n.histograms[0].counts[1]||0;return r>t?3:r<=e?1:2}},g=function(e,t,n){return function(r){if(!r.histograms[0])return v(e,t,0);var i=r.histograms[0].counts[1]||0,s=C(i,n),o=s/d,u={low:e,high:t};return v(e,t,o)}},y=function(e){if(!e.histograms.length)return 1;var t=e.histograms[0].counts[1];return t>0?3:1},b=function(e){if(!e.histograms.length)return 1;var t=e.histograms[0].counts;return t[2]?3:t[1]?3:1},w=function(e,t,n){return{rasterFunction:"Remap",rasterFunctionArguments:{InputRanges:e,OutputValues:t,Raster:n,AllowUnmatched:!1},variableName:"Raster"}},E=function(e){return w([0,1,1,14],[0,1],e)},S=function(e){return w([1,22],[1],e)},x=function(e){return w([1,20,20,369],[0,1],e)},T=function(e,t,n){return{rasterFunction:"Arithmetic",rasterFunctionArguments:{Raster:e,Raster2:t,Operation:n}}},N=function(e){return{mosaicMethod:"esriMosaicLockRaster",lockRasterIds:[parseInt(e.replace("$",""))],ascending:!0,mosaicOperation:"MT_FIRST"}},C=function(e,t){var n=t*t,r=e*n;return r},k={histogram:s.computeHistogram,query:s.queryEsri},L=function(e,t,n){},A={low:7,high:12},O=[{label:"legal",categories:["legal"],singleIndicator:!0},{label:"deforestation",high:21,low:13},{label:"peat",high:7,low:4},{label:"rspo",categories:["rspo"]},{label:"fire",categories:["fire"],singleIndicator:!0}],M=[{key:"carbon",category:"deforestation",service:c.commodities,request:k.histogram,params:{renderingRule:T(E(o.treeCoverLoss.rasterId),w([0,20,20,80,80,100],[0,1,2],o.carbonDensity.rasterId),3),pixelSize:100},callbacks:{radius:b,concession:b}},{key:"forma",category:"deforestation",service:c.commodities,request:k.histogram,params:{renderingRule:S(o.clearanceAlerts.rasterId),pixelSize:500},callbacks:{radius:m(1,5),concession:m(25,295)}},{key:"forma_carbon",category:"deforestation",service:c.commodities,request:k.histogram,params:{renderingRule:T(S(o.clearanceAlerts.rasterId),x(o.carbonDensity.rasterId),3),pixelSize:30},callbacks:{radius:y,concession:y}},{key:"area_carbon",category:"deforestation",service:c.commodities,request:k.histogram,params:{renderingRule:x(o.carbonDensity.rasterId),pixelSize:30},callbacks:{radius:g(.747,.913,30),concession:g(0,.2,30)}},{key:"area_primary",category:"deforestation",service:c.commodities,request:k.histogram,ind_params:{renderingRule:w([0,1,1,3],[0,1],o.primaryForest.rasterId),pixelSize:100},params:{renderingRule:w([0,1,1,3],[0,1],o.intactForest.rasterId),pixelSize:100},callbacks:{radius:g(.12,.18,100),concession:g(0,.2,100)}},{key:"forma_primary",category:"deforestation",service:c.commodities,request:k.histogram,ind_params:{renderingRule:T(S(o.clearanceAlerts.rasterId),w([1,3],[1],o.primaryForest.rasterId),3),pixelSize:30},params:{renderingRule:T(S(o.clearanceAlerts.rasterId),o.intactForest.rasterId,3),pixelSize:30},callbacks:{radius:y,concession:y}},{key:"umd_loss",category:"deforestation",service:c.commodities,request:k.histogram,params:{renderingRule:E(o.treeCoverLoss.rasterId),pixelSize:30},callbacks:{radius:g(.001,.28*.02,30),concession:g(.05,.28,30)}},{key:"umd_loss_primary",category:"deforestation",service:c.commodities,request:k.histogram,ind_params:{renderingRule:T(E(o.treeCoverLoss.rasterId),o.primaryForest.rasterId,3),pixelSize:100},params:{renderingRule:T(E(o.treeCoverLoss.rasterId),o.intactForest.rasterId,3),pixelSize:100},callbacks:{radius:y,concession:y}},{key:"fire",category:"fire",service:c.fires,request:k.query,params:{where:"BRIGHTNESS>=330 AND CONFIDENCE>=30",geometry:""},execution:"executeForCount",callback:function(e,t){return e>0?3:1},callbacks:{radius:function(e,t){return e>0?3:1},concession:function(e,t){return e>0?3:1}}},{key:"legal",category:"legal",service:c.commodities,request:k.histogram,ind_params:{renderingRule:w([0,1,1,2,2,3,3,4,4,7],[1,0,1,0,1],o.legalClass.rasterId),pixelSize:100},params:{renderingRule:N(o.protectedArea.rasterId),pixelSize:100},callbacks:{radius:y,concession:y},ind_callback:y},{key:"clearance",category:"peat",service:c.commodities,request:k.histogram,params:{renderingRule:T(E(o.treeCoverLoss.rasterId),o.peatLands.rasterId,3),pixelSize:100},callbacks:{radius:y,concession:y}},{key:"alerts",category:"peat",service:c.commodities,request:k.histogram,params:{renderingRule:T(S(o.clearanceAlerts.rasterId),o.peatLands.rasterId,3),pixelSize:100},callbacks:{radius:y,concession:y}},{key:"presence",category:"peat",service:c.commodities,request:k.histogram,params:{renderingRule:w([0,1,1,2],[0,1],o.peatLands.rasterId),pixelSize:100},callbacks:{radius:g(.00531,.00693),concession:g(.00531,.00693)}}],D=function(e){var t=_.groupBy(M,"key"),e=t[e][0].category;return e},P=function(e,t){var r=n.clone(O),i=0;return _.forIn(e,function(e,n){var r=D(n);h[r]||(h[r]={});var s=_.result(_.find(O,{label:r}),"singleIndicator");s?(h[r][t]={risk:l[e]},i+=e):(h[r][n]||(h[r][n]={}),h[r][n][t]={risk:l[e]})}),r.forEach(function(n){var r=0;if(!n.high)return;var s=[],o=_.pluck(_.groupBy(M,"category")[n.label],"key");M.forEach(function(t,n){r+=e[t],i+=e[t],s.push({key:t,risk:e[t]})}),n.categories=s;var u=v(n.high,n.low,r),a=n.label;n.risk=u,h[a]||(h[a]={});var f=n.label+"_"+t;h[a][f]=l[u]}),i=v(A.low,A.high,i),h["priority_level_"+t]=l[i],i>h.total_mill_priority_level&&(h.total_mill_priority_level=i),h},H=new e;a=a,f=f,h.total_mill_priority_level=h.total_mill_priority_level||0;var B=[];if(!r){var j={};return _.pluck(M,"key").forEach(function(e){j[e]=0}),P(j,u),H.resolve(j),H.promise}var F=function(e,n,r,i){var s=e.map(function(e){return r.geometry=JSON.stringify(e),n.request(n.service,r,n.execution)});t(s).then(function(e){var t={histograms:[{counts:[]}]},r=_.pluck(_.flatten(_.pluck(e,"histograms")),"counts");r.forEach(function(e){e.forEach(function(e,n){t.histograms[0].counts[n]=t.histograms[0].counts[n]||0,t.histograms[0].counts[n]+=e})});var s={},o=n.callbacks[u];n.results=t,s[n.key]=o(t,i),i.resolve(s)},function(e){console.log("SPLIT ERROR",e)})};return M.forEach(function(t){var n=new e,i=f&&t.ind_params?t.ind_params:t.params;t.request==s.computeHistogram?(i.renderingRule=JSON.stringify(i.renderingRule),i.mosaicRule=i.mosaicRule?JSON.stringify(i.mosaicRule):"",i.geometryType="esriGeometryPolygon",i.geometry=JSON.stringify(r)):i.geometry=r,i.f="json",t.request(t.service,i,t.execution).then(function(e){var r={},i=t.callbacks[u];t.results=e,r[t.key]=i(e,n),n.resolve(r)},function(e){console.log("HISTOGRAM ERROR",e),p&&F(p,t,i,n)}),B.push(n.promise)}),t(B).then(function(e){var t={};e.forEach(function(e){n.mixin(t,e)});var r=P(t,u);H.resolve(r)}),H.promise},u.getGeometryArea=function(t,n){var r=new e,i={areaUnit:"UNIT_SQUARE_METERS",lengthUnit:"UNIT_METERS",calculationType:"geodesic",polygons:[n]};return s.getAreasLengths(t,i).then(function(e){r.resolve(e.areas[0])}),r},u.getConcessionRisk=function(t,n,a,l){var h=new e,p=c.concessions,d=new i(t),v={geometry:d,where:"CERT_SCHEME = 'RSPO' AND TYPE = 'Oil palm concession'",outFields:["OBJECTID"],returnGeometry:!0};return s.queryEsri(p,v).then(function(e){var t=o.geometryServiceUrl,c=e.features.map(function(e){return e.geometry});if(c.length<1){var p={};u.getRiskByGeometry(!1,0,"concession",n,a,l),h.resolve();return}var d=r.union(c),v=r.simplify(d),m=new i(v),g={geometries:[m]};s.project(t,g,f).then(function(e){var r=new i(e[0]);u.getGeometryArea(t,r).then(function(t){var r=u.getRiskByGeometry(e[0],t,"concession",n,a,l,c);r.then(function(e){h.resolve()})})})}),h},u.printProjectGeom=function(e){var t=o.geometryServiceUrl,n=new i(e),r={geometries:[n]};s.project(t,r,102100).then(function(e){console.log("BUFFER GEOM",JSON.stringify(e[0]))})},u.getRadiusBuffer=function(t,n){var r=o.geometryServiceUrl,i=new e,a={unit:"UNIT_KILOMETER",distances:[n],geometries:[t]};return s.buffer(r,a,f).then(function(e){var t=e[0];u.getGeometryArea(r,t).then(function(t){i.resolve({geometry:e[0],area:t})})}),i},u.getRisk=function(r,i,s,o){var a=new e,f={};return u.getRadiusBuffer(r,i).then(function(e){var r=i*1e3*i*1e3*Math.PI,c=e.geometry,h=u.getRiskByGeometry(c,r,"radius",s,o,f),p=u.getConcessionRisk(c,s,o,f);t([h,p]).then(function(e){f.total_mill_priority_level=l[f.total_mill_priority_level],a.resolve(n.clone(f))})}),a},u}),define("report/RiskHelper",["report/config","dojo/Deferred","dojo/_base/lang","dojo/promise/all","dojo/_base/array","esri/tasks/query","esri/tasks/QueryTask","report/riskController","esri/geometry/geometryEngine"],function(e,t,n,r,i,s,o,u,a){"use strict";var f={prepareFeatures:function(e){var n=new t,s=[],o=this;return i.forEach(e,function(e){var n=new t;o.getAreaAndIndoIntersect(e).then(function(e){n.resolve({feature:e.feature,inIndonesia:e.inIndonesia})}),s.push(n.promise)}),r(s).then(function(e){o.performAnalysis(e).then(function(e){n.resolve(e)})}),n.promise},getAreaAndIndoIntersect:function(e){var n=new t;return this.getIntersectionStatus(e).then(function(t){n.resolve({feature:e,inIndonesia:t})}),n.promise},getIntersectionStatus:function(n){var r=new t,i,u;return u=new o(e.boundariesUrl),i=new s,i.returnGeometry=!0,i.outFields=["OBJECTID"],i.where="ISO3 = 'IDN'",i.geometryPrecision=1,u.execute(i,function(e){var t=e.features[0]&&e.features[0].geometry;r.resolve(a.contains(t,n.geometry))},function(e){r.resolve(!1)}),r.promise},performAnalysis:function(e){var n=new t,s=this,o=[],a,f,l,c;return i.forEach(e,function(e){var n=new t;c=e.feature.isRSPO||!1,f=e.feature.geometry.getExtent().getCenter(),a=e.inIndonesia,l=JSON.parse(e.feature.buffer),r([u.getRisk(f,l,c,a)]).then(function(t){n.resolve({feature:e.feature,results:t})}),o.push(n)}),r(o).then(function(e){var t=s.formatData(e);n.resolve(t)}),n.promise},formatData:function(e){var t=[],r;return i.forEach(e,function(e){r=n.clone(e.results[0]),r.id=e.feature.millId,r.rspo={risk:e.feature.isRSPO},t.push(r)}),t}};return f}),define("report/Suitability",["esri/request","esri/tasks/query","esri/tasks/QueryTask","esri/geometry/Polygon","report/config","utils/Analytics","dojo/Deferred","dojo/_base/lang","dojo/_base/array","dojo/promise/all","report/CSVExporter"],function(e,t,n,r,i,s,o,u,a,f,l){return{getSuitabilityData:function(){function n(n){e.resolve(n),t.attachEvents()}var e=new o,t=this;return f([this.getSuitableAreas(),this.getLCHistogramData(),this.getRoadData(),this.getConcessionData(),this.computeLegalHistogram()]).then(n),e.promise},attachEvents:function(){$("#suitability-table-csv").click(this.downloadSuitabilityTable),$("#suitability-settings-csv").click(this.downloadSuitabiltiySettings)},downloadSuitabilityTable:function(){var e="\r\n",t,n;n=l.exportSuitabilityStatistics(),t=n.join(e),l.exportCSV(t),s.sendEvent("Event","click","Download CSV","User downloaded Suitability results table.")},downloadSuitabiltiySettings:function(){l.exportCSV(payload.suitability.csv),s.sendEvent("Event","click","Download CSV","User downloaded Suitability settings.")},getSuitableAreas:function(e){function l(e){e.histograms.length>0?(f.data=e.histograms[0],f.pixelSize=a.pixelSize,t.resolve(f)):t.resolve(!1)}function c(e){e.details?e.details[0]==="The requested image exceeds the size limit."&&a.pixelSize!==500?(a.pixelSize=500,s.getHistogram(r,a,l,c)):t.resolve(!1):t.resolve(!1)}var t=new o,n=u.clone(report.suitable.renderRule),r=i.suitability.url,s=this,a={f:"json",pixelSize:100,geometryType:i.suitability.geometryType,geometry:JSON.stringify(report.geometry)},f={};return n.rasterFunction=i.suitability.rasterFunction,a.renderingRule=JSON.stringify(n),this.getHistogram(r,a,l,c),t.promise},getLCHistogramData:function(){function f(t){t.histograms.length>0?(a.data=t.histograms[0],a.pixelSize=u.pixelSize,e.resolve(a)):e.resolve(!1)}function l(t){t.details?t.details[0]==="The requested image exceeds the size limit."&&u.pixelSize!==500?(u.pixelSize=500,s.getHistogram(r,u,f,l)):e.resolve(!1):e.resolve(!1)}var e=new o,t=i.suitability.lcHistogram,n=t.renderRule,r=i.suitability.url,s=this,u={f:"json",pixelSize:100,geometryType:i.suitability.geometryType,geometry:JSON.stringify(report.geometry),renderingRule:JSON.stringify(n)},a={};return this.getHistogram(r,u,f,l),e.promise},getRoadData:function(){function f(t){t.histograms.length>0?(a.data=t.histograms[0],a.pixelSize=u.pixelSize,e.resolve(a)):e.resolve(!1)}function l(t){t.details?t.details[0]==="The requested image exceeds the size limit."&&u.pixelSize!==500?(u.pixelSize=500,s.getHistogram(n,u,f,l)):e.resolve(!1):e.resolve(!1)}var e=new o,t=i.suitability.roadHisto,n=i.suitability.url,r=t.mosaicRule,s=this,u={f:"json",pixelSize:100,geometryType:i.suitability.geometryType,geometry:JSON.stringify(report.geometry),mosaicRule:JSON.stringify(r)},a={};return this.getHistogram(n,u,f,l),e.promise},getConcessionData:function(){var e=new o,s=i.suitability.concessions,u=new t,a=new n(s.url+"/"+s.layer);return u.returnGeometry=!1,u.geometry=new r(report.geometry),a.executeForCount(u,function(t){e.resolve({value:t>0?"Yes":"No"})},function(t){e.resolve(!1)}),e.promise},computeLegalHistogram:function(){function c(t){t.histograms.length>0?(l.data=t.histograms[0],l.pixelSize=f.pixelSize,e.resolve(l)):e.resolve(!1)}function h(t){t.details?t.details[0]==="The requested image exceeds the size limit."&&f.pixelSize!==500?(f.pixelSize=500,a.getHistogram(s,f,c,h)):e.resolve(!1):e.resolve(!1)}var e=new o,t=u.clone(report.suitable.renderRule),n=i.suitability.lcHistogram,r=n.renderRuleSuitable,s=i.suitability.url,a=this,f={f:"json",pixelSize:100,geometryType:i.suitability.geometryType,geometry:JSON.stringify(report.geometry)},l={};return u.mixin(t.rasterFunctionArguments,r.rasterFunctionArguments),t.rasterFunction=r.rasterFunction,f.renderingRule=JSON.stringify(t),this.getHistogram(s,f,c,h),e.promise},getCompositionAnalysis:function(){var e=new o,t=[],n=this;return f([n.getElevationComposition(),n.getSlopeComposition(),n.getWaterComposition(),n.getConservationComposition()]).then(function(t){f([n.getSoilTypeComposition(),n.getSoilDepthComposition(),n.getPeatComposition(),n.getSoilAcidityComposition()]).then(function(r){f([n.getSoilDrainComposition(),n.getRainfallComposition(),n.getLandCoverComposition()]).then(function(n){e.resolve(t.concat(r.concat(n)))})})}),e.promise},getElevationComposition:function(){var e=new o,t=this,n,r,i;return n=this.getCompositionRemapRule("$1","ElevInpR","ElevOutV"),this.queryComposition(n,function(n){i=t.formatCompositionResults(n,"Elevation"),e.resolve(i)}),e.promise},getSlopeComposition:function(){var e=new o,t=this,n,r,i;return n=this.getCompositionRemapRule("$2","SlopeInpR","SlopeOutV"),this.queryComposition(n,function(n){i=t.formatCompositionResults(n,"Slope"),e.resolve(i)}),e.promise},getWaterComposition:function(){var e=new o,t=this,n,r,i;return n=this.getCompositionRemapRule("$3","WaterInpR","WaterOutV"),this.queryComposition(n,function(n){i=t.formatCompositionResults(n,"Water Resource Buffers"),e.resolve(i)}),e.promise},getConservationComposition:function(){var e=new o,t=this,n,r,i;return n=this.getCompositionRemapRule("$4","ConsInpR","ConsOutV"),this.queryComposition(n,function(n){i=t.formatCompositionResults(n,"Conservation Area Buffers"),e.resolve(i)}),e.promise},getSoilTypeComposition:function(){var e=new o,t=this,n,r,i;return n=this.getCompositionRemapRule("$5","STypeInpR","STypeOutV"),this.queryComposition(n,function(n){i=t.formatCompositionResults(n,"Soil Type"),e.resolve(i)}),e.promise},getSoilDepthComposition:function(){var e=new o,t=this,n,r,i;return n=this.getCompositionRemapRule("$6","SDepthInpR","SDepthOutV"),this.queryComposition(n,function(n){i=t.formatCompositionResults(n,"Soil Depth"),e.resolve(i)}),e.promise},getPeatComposition:function(){var e=new o,t=this,n,r,i;return n=this.getCompositionRemapRule("$7","PeatInpR","PeatOutV"),this.queryComposition(n,function(n){i=t.formatCompositionResults(n,"Peat Depth"),e.resolve(i)}),e.promise},getSoilAcidityComposition:function(){var e=new o,t=this,n,r,i;return n=this.getCompositionRemapRule("$8","SAcidInpR","SAcidOutV"),this.queryComposition(n,function(n){i=t.formatCompositionResults(n,"Soil Acidity"),e.resolve(i)}),e.promise},getSoilDrainComposition:function(){var e=new o,t=this,n,r,i;return n=this.getCompositionRemapRule("$9","SDrainInpR","SDrainOutV"),this.queryComposition(n,function(n){i=t.formatCompositionResults(n,"Soil Drainage"),e.resolve(i)}),e.promise},getRainfallComposition:function(){var e=new o,t=this,n,r,i;return n=this.getCompositionRemapRule("$10","RainfallInpR","RainfallOutV"),this.queryComposition(n,function(n){i=t.formatCompositionResults(n,"Rainfall"),e.resolve(i)}),e.promise},getLandCoverComposition:function(){var e=new o,t=this,n,r,i;return n=this.getCompositionRemapRule("$11","LCInpR","LCOutV"),this.queryComposition(n,function(n){i=t.formatCompositionResults(n,"Land Cover"),e.resolve(i)}),e.promise},getCompositionRemapRule:function(e,t,n){var r=u.clone(report.suitable.renderRule);return{rasterFunction:"Remap",rasterFunctionArguments:{InputRanges:r.rasterFunctionArguments[t],OutputValues:r.rasterFunctionArguments[n],Raster:e},outputPixelType:"U2"}},queryComposition:function(e,t){function o(e){var n;e.histograms.length>0?(n=e.histograms[0]&&e.histograms[0].counts||[0,0],t(n)):(n=[0,0],t(n))}function u(e){e.details?e.details[0]==="The requested image exceeds the size limit."&&r.pixelSize!==500?(r.pixelSize=500,self.getHistogram(n,r,o,u)):t(!1):t(!1)}var n=i.suitability.url,r={f:"json",pixelSize:100,geometryType:i.suitability.geometryType,geometry:JSON.stringify(report.geometry),renderingRule:JSON.stringify(e)},s;this.getHistogram(n,r,o,u)},formatCompositionResults:function(e,t){return{unsuitable:e[0]||0,suitable:e[1]||0,label:t}},getHistogram:function(t,n,r,i){var s=e({url:t+"/computeHistograms?",content:n,handleAs:"json",callbackParamName:"callback"});s.then(r,i)}}}),define("report/Fetcher",["dojo/number","dojo/Deferred","dojo/promise/all","dojo/_base/array","report/config","report/Renderer","report/RiskHelper","report/Suitability","esri/map","esri/request","esri/tasks/query","esri/dijit/Scalebar","esri/tasks/QueryTask","esri/SpatialReference","esri/geometry/Polygon","esri/tasks/GeometryService","esri/tasks/AreasAndLengthsParameters","esri/Color","esri/graphic","esri/symbols/SimpleFillSymbol"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b){"use strict";var w=[];return{getAreaFromGeometry:function(n){function c(t){t.areas.length===1?(l=e.format(t.areas[0],{places:0}),report.area=t.areas[0],r.resolve(l)):(l=f,r.resolve(!1))}function h(e){r.resolve(!1)}this._debug("Fetcher >>> getAreaFromGeometry");var r=new t,s=new v(i.geometryServiceUrl),o=new m,u=new p(54012),a=new d(n),f="Not Available",l;return o.areaUnit=v.UNIT_HECTARES,s.project([a],u,function(e){e.length>0?(a.rings=e[0].rings,a.setSpatialReference(u)):h(),s.simplify([a],function(e){o.polygons=e,s.areasAndLengths(o,c,h)},h)},h),r.promise},setupMap:function(){function s(){i.graphics.clear(),i.resize(),e=new c({map:i,scalebarUnit:"metric"}),n=new b,r=new d(report.geometry),t=new y(r,n),i.graphics.add(t),i.setExtent(t.geometry.getExtent().expand(3),!0)}var e,t,n,r,i;i=new a("print-map",{basemap:"topo",sliderPosition:"top-right"}),i.on("load",s)},getPrimaryForestResults:function(){this._debug("Fetcher >>> getPrimaryForestResults");var e=new t,r=i.primaryForest;return s.renderContainers(r),w.push(r),n([this._getTotalLossAnalysis(r),this._getClearanceAlertAnalysis(r),this._getCompositionAnalysis(r)]).then(function(){e.resolve(!0)}),e.promise},getTreeCoverResults:function(){this._debug("Fetcher >>> getTreeCoverResults");var e=new t,r=i.treeCover;return s.renderContainers(r),w.push(r),n([this._getTotalLossAnalysis(r),this._getClearanceAlertAnalysis(r),this._getCompositionAnalysis(r)]).then(function(){e.resolve(!0)}),e.promise},getTreeCoverLossResults:function(){function f(t){t.histograms.length>0?(s.renderTreeCoverLossData(t.histograms[0].counts,u.pixelSize,n),s.renderCompositionAnalysis(t.histograms[0].counts,u.pixelSize,n)):s.renderAsUnavailable("loss",n),e.resolve(!0)}function l(t){t.details?t.details[0]==="The requested image exceeds the size limit."&&u.pixelSize!==500?(u.pixelSize=500,a._computeHistogram(r,u,f,l)):e.resolve(!1):e.resolve(!1)}this._debug("Fetcher >>> getTreeCoverLossResults");var e=new t,n=i.treeCoverLoss,r=i.imageServiceUrl,o=n.rasterId,u={geometryType:"esriGeometryPolygon",geometry:JSON.stringify(report.geometry),mosaicRule:JSON.stringify(n.mosaicRule),pixelSize:report.geometry.rings.length>45?500:100,f:"json"},a=this;return s.renderTotalLossContainer(n),s.renderCompositionAnalysisLoader(n),this._computeHistogram(r,u,f,l),e.promise},getLegalClassResults:function(){this._debug("Fetcher >>> getLegalClassResults");var e=new t,r=i.legalClass;return s.renderContainers(r),w.push(r),n([this._getTotalLossAnalysis(r),this._getClearanceAlertAnalysis(r)]).then(function(){e.resolve(!0)}),e.promise},getIndonesiaMoratoriumResults:function(){this._debug("Fetcher >>> getProtectedAreaResults");var e=new t,r=i.indonesiaMoratorium;return s.renderContainers(r),w.push(r),n([this._getTotalLossAnalysis(r,!0),this._getClearanceAlertAnalysis(r,!0),this._getCompositionAnalysis(r)]).then(function(){e.resolve(!0)}),e.promise},getProtectedAreaResults:function(){this._debug("Fetcher >>> getProtectedAreaResults");var e=new t,r=i.protectedArea;return s.renderContainers(r),w.push(r),n([this._getTotalLossAnalysis(r,!0),this._getClearanceAlertAnalysis(r,!0),this._getCompositionAnalysis(r)]).then(function(){e.resolve(!0)}),e.promise},getCarbonStocksResults:function(){this._debug("Fetcher >>> getCarbonStocksResults");var e=new t,r=i.carbonStock;return s.renderContainers(r),w.push(r),n([this._getTotalLossAnalysis(r),this._getClearanceAlertAnalysis(r)]).then(function(){e.resolve(!0)}),e.promise},getIntactForestResults:function(){this._debug("Fetcher >>> getIntactForestResults");var e=new t,r=i.intactForest;return s.renderContainers(r),w.push(r),n([this._getTotalLossAnalysis(r,!0),this._getClearanceAlertAnalysis(r,!0)]).then(function(){e.resolve(!0)}),e.promise},getLandCoverGlobalResults:function(){this._debug("Fetcher >>> getLandCoverGlobalResults");var e=new t,r=i.landCoverGlobal;return s.renderContainers(r),w.push(r),n([this._getTotalLossAnalysis(r),this._getClearanceAlertAnalysis(r)]).then(function(){e.resolve(!0)}),e.promise},getLandCoverAsiaResults:function(){this._debug("Fetcher >>> getLandCoverAsiaResults");var e=new t,r=i.landCoverAsia;return s.renderContainers(r),w.push(r),n([this._getTotalLossAnalysis(r),this._getClearanceAlertAnalysis(r)]).then(function(){e.resolve(!0)}),e.promise},getLandCoverIndonesiaResults:function(){this._debug("Fetcher >>> getLandCoverIndonesiaResults");var e=new t,r=i.landCoverIndo;return s.renderContainers(r),w.push(r),n([this._getTotalLossAnalysis(r),this._getClearanceAlertAnalysis(r)]).then(function(){e.resolve(!0)}),e.promise},getPeatLandsResults:function(){this._debug("Fetcher >>> getPeatLandsResults");var e=new t,r=i.peatLands;return s.renderContainers(r),w.push(r),n([this._getTotalLossAnalysis(r,!0),this._getClearanceAlertAnalysis(r,!0),this._getCompositionAnalysis(r)]).then(function(){e.resolve(!0)}),e.promise},getRSPOResults:function(){function l(t){s.renderRSPOData(t,n,o),e.resolve(!0)}function c(t){t.details?t.details[0]==="The requested image exceeds the size limit."&&a.pixelSize!==500?(a.pixelSize=500,f._computeHistogram(r,a,l,c)):e.resolve(!1):e.resolve(!1)}this._debug("Fetcher >>> getRSPOResults");var e=new t,n=i.rspo,r=i.imageServiceUrl,o=this._getEncodingFunction(n.lossBounds,n.bounds),u=o.render(i.totalLoss.rasterId,n.rasterId),a={geometryType:"esriGeometryPolygon",geometry:JSON.stringify(report.geometry),renderingRule:u,pixelSize:100,f:"json"},f=this;return s.renderRSPOContainer(n),this._computeHistogram(r,a,l,c),e.promise},_getTotalLossAnalysis:function(e,n){function p(t){if(t.histograms.length>0)s.renderLossData(t.histograms[0].counts,c.pixelSize,e,a,n);else{var i=Array.apply(null,new Array(o.labels.length)).map(Number.prototype.valueOf,0);s.renderLossData(i,c.pixelSize,e,a,n)}r.resolve(!0)}function d(e){e.details?e.details[0]==="The requested image exceeds the size limit."&&c.pixelSize!==500?(c.pixelSize=500,h._computeHistogram(u,c,p,d)):r.resolve(!1):r.resolve(!1)}this._debug("Fetcher >>> _getTotalLossAnalysis");var r=new t,o=i.totalLoss,u=i.imageServiceUrl,a=this._getEncodingFunction(o.bounds,e.bounds),f=e.rasterRemap?e.rasterRemap:e.rasterId,l=n?a.getSimpleRule(o.rasterId,f):a.render(o.rasterId,f),c={geometryType:"esriGeometryPolygon",geometry:JSON.stringify(report.geometry),renderingRule:l,pixelSize:report.geometry.rings.length>45?500:100,f:"json"},h=this;return this._computeHistogram(u,c,p,d),r.promise},_getClearanceAlertAnalysis:function(e,n){function p(t){if(t.histograms.length>0)s.renderClearanceData(t.histograms[0].counts,c.pixelSize,e,h,n);else{var i=Array.apply(null,new Array(report.clearanceLabels.length)).map(Number.prototype.valueOf,0);s.renderClearanceData(i,c.pixelSize,e,h,n)}r.resolve(!0)}function d(e){r.resolve(!1)}this._debug("Fetcher >>> _getClearanceAlertAnalysis");var r=new t,o=i.clearanceAlerts,u=i.clearanceAnalysisUrl,a=this,f,l,c,h;return e.formaId&&(e.rasterId=e.formaId,e.includeFormaIdInRemap&&(e.rasterRemap.rasterFunctionArguments.Raster=e.formaId)),h=this._getEncodingFunction(report.clearanceBounds,e.bounds),l=e.rasterRemap?e.rasterRemap:e.rasterId,f=n?h.getSimpleRule(o.rasterId,l):h.render(o.rasterId,l),c={geometryType:"esriGeometryPolygon",geometry:JSON.stringify(report.geometry),renderingRule:f,pixelSize:500,f:"json"},this._computeHistogram(u,c,p,d),r.promise},_getCompositionAnalysis:function(e){function f(t){t.histograms.length>0?s.renderCompositionAnalysis(t.histograms[0].counts,u.pixelSize,e):s.renderAsUnavailable("composition",e),n.resolve(!0)}function l(e){e.details?e.details[0]==="The requested image exceeds the size limit."&&u.pixelSize!==500?(u.pixelSize=500,a._computeHistogram(r,u,f,l)):n.resolve(!1):n.resolve(!1)}s.renderCompositionAnalysisLoader(e);var n=new t,r=i.imageServiceUrl,o=e.compositionAnalysis,u={geometryType:"esriGeometryPolygon",geometry:JSON.stringify(report.geometry),mosaicRule:JSON.stringify({mosaicMethod:"esriMosaicLockRaster",lockRasterIds:[o.rasterId],ascending:!0,mosaicOperation:"MT_FIRST"}),pixelSize:report.geometry.rings.length>45?500:100,f:"json"},a=this;return this._computeHistogram(r,u,f,l),n.promise},_getSuitabilityAnalysis:function(){this._debug("Fetcher >>> _getSuitabilityAnalysis");var e=new t,n=i.suitability;return s.renderSuitabilityContainer(n),u.getSuitabilityData().then(function(t){s.renderSuitabilityData(n,t),u.getCompositionAnalysis().then(function(t){s.renderSuitabilityCompositionChart(t),e.resolve(!0)})}),e.promise},_getMillPointAnalysis:function(){function h(){var e=new XMLHttpRequest,t;e.open("POST",u.url,!0),e.onreadystatechange=function(n){e.readyState===4&&(e.status===200?(t=JSON.parse(e.response),t.mills?f.resolve(t.mills):f.resolve(!1)):f.resolve(!1))},e.addEventListener("error",function(){f.resolve(!1)},!1);var n=new FormData;n.append("mills",c.map(function(e){return e.millId}).join(",")),e.send(n)}function p(){o.prepareFeatures(l).then(function(e){a.resolve(e)})}this._debug("Fetcher >>> _getMillPointAnalysis");var e=new t,u=i.millPoints,a=new t,f=new t,l=[],c=[];return s.renderMillContainer(u),r.forEach(report.mills,function(e){e.isCustom?l.push(e):c.push(e)}),c.length>0?h():f.resolve(),l.length>0?p():a.resolve(!1),n([a,f]).then(function(t){var n=[];r.forEach(t,function(e){e&&(n=n.concat(e))}),s.renderMillAssessment(n,u),e.resolve(!0)}),e.promise},_getFireAlertAnalysis:function(){this._debug("Fetcher >>> _getFireAlertAnalysis");var e=new t,r=new d(report.geometry),o=new Date,u="",a=0,f=this,c=[],p,v,m,g;return v=new l,g=new h(i.fires.url+"/4"),v.geometry=r,v.returnGeometry=!1,v.outFields=["*"],v.where="1 = 1",m=new h("http://gis-potico.wri.org/arcgis/rest/services/Fires/FIRMS_ASEAN/MapServer/0"),p=new l,p.geometry=r,p.returnGeometry=!1,p.outFields=["moratorium"],o.setDate(o.getDate()-8),u=o.getFullYear()+"-"+(o.getMonth()+1)+"-"+o.getDate()+" "+o.getHours()+":"+o.getMinutes()+":"+o.getSeconds(),p.where="ACQ_DATE > date '"+u+"'",n([g.execute(v),m.execute(p)]).then(function(t){s.renderFireData(w,t),e.resolve(!0)}),g.on("error",function(){e.resolve(!1)}),e.promise},_getClearanceBounds:function(){this._debug("Fetcher >>> _getClearanceBounds");var e=i.clearanceBounds,n=new t,r=0,s,o;return o=f({url:e.url,content:{f:"pjson"},handleAs:"json",callbackParamName:"callback"}),o.then(function(t){report.clearanceBounds=[t.minValues[0],t.maxValues[0]],report.clearanceLabels=[];for(var i=t.minValues[0],o=t.maxValues[0];i<=o;i++)s=i%12===0?12:i%12,report.clearanceLabels.push(s+"-"+(e.baseYearLabel+r)),i%12===0&&++r;n.resolve(!0)},function(e){n.resolve(!1,e)}),n.promise},_getEncodingFunction:function(e,t,n){var r=this;return{A:e.fromBounds(),B:t.fromBounds(),getSimpleRule:function(e,t){return JSON.stringify({rasterFunction:"Arithmetic",rasterFunctionArguments:{Raster:e,Raster2:t,Operation:3}})},renderRule:function(e,t){return{rasterFunction:"Arithmetic",rasterFunctionArguments:{Raster:{rasterFunction:"Arithmetic",rasterFunctionArguments:{Raster:{rasterFunction:"Remap",rasterFunctionArguments:{InputRanges:[this.A[0],this.A[this.A.length-1]+1],OutputValues:[this.B.length],Raster:e,AllowUnmatched:!1}},Raster2:e,Operation:3}},Raster2:t,Operation:1}}},render:function(e,t){return JSON.stringify(this.renderRule(e,t))},encode:function(e,t){return this.B.length*e+t},decode:function(e){var t=e%this.B.length,n=(e-t)/this.B.length;return[n,t]}}},_computeHistogram:function(e,t,n,r){var i=f({url:e+"/computeHistograms",content:t,handleAs:"json",callbackParamName:"callback",timeout:6e4},{usePost:!0});i.then(n,r)},_debug:function(e){console.log(e)}}}),define("report/Generator",["dojo/on","dojo/dom","dojo/query","esri/config","dojo/request/xhr","dojo/Deferred","dojo/dom-class","dojo/dom-style","dojo/promise/all","dojo/_base/array","dijit/Dialog","dojox/validate/web","esri/geometry/Point","esri/geometry/Polygon","esri/SpatialReference","esri/tasks/GeometryService","esri/geometry/webMercatorUtils","utils/Analytics","report/config","report/Fetcher","report/CSVExporter","esri/units","esri/geometry/Circle"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S){"use strict";return window.report={},{init:function(){window.payload&&(this.applyConfigurations(),this.prepareForAnalysis(),this.addSubscriptionDialog(),this.setupHeader())},applyConfigurations:function(){f.forEach(y.corsEnabledServers,function(e){r.defaults.io.corsEnabledServers.push(e)}),Highcharts.setOptions({chart:{style:{fontFamily:"'Fira Sans', 'fira_sans_otregular', Georgia, serif"}}}),this.addCSVOptionToHighcharts()},setupHeader:function(){var n=t.byId("total-area-info-icon");e(n,"click",function(e){u.set("total-area-info-popup","visibility","visible")}),n=t.byId("total-area-close-info-icon"),e(n,"click",function(e){u.set("total-area-info-popup","visibility","hidden")})},addCSVOptionToHighcharts:function(){function t(){var e=document.getElementById("title").innerHTML,t=this.options.chart.type,n="\r\n",r=[],i,s;r.push(t==="column"?"RSPO Land Use Change Analysis":this.title.textStr),r.push(e),t==="bar"&&this.xAxis.length>1?(i=w.exportCompositionAnalysis(this),r=r.concat(i)):t==="pie"?(i=w.exportSuitabilityByLegalClass(this),r=r.concat(i)):(i=w.exportSimpleChartAnalysis(this),r=r.concat(i)),r.length>1&&(s=r.join(n)),s&&w.exportCSV(s);var o=t==="column"?"RSPO Land Use Change Analysis":this.title.textStr;g.sendEvent("Event","click","Download CSV",o)}var e=this;Highcharts.getOptions().exporting.buttons.contextButton.menuItems.push({text:"Download CSV",onclick:t})},prepareForAnalysis:function(){var e=this,t=new v(y.geometryServiceUrl),n=new d(102100),r,i,s,o;this.setTitleAndShowReport(window.payload.title),report.suitable=window.payload.suitability,report.datasets=window.payload.datasets;var u=JSON.parse(window.payload.geometry);if(u.length===1){var a=u[0];a.geometry.radius?(o=new p(n),o.addRing(a.geometry.rings[a.geometry.rings.length-1]),report.geometry=o,a.geometry=report.geometry,report.mills=[a]):a.geometry.type==="polygon"&&(report.geometry=a.geometry),this.beginAnalysis()}else i=[],f.forEach(u,function(e){e.geometry.center&&(o=new p(n),o.addRing(e.geometry.rings[e.geometry.rings.length-1]),i.push(o),e.geometry=o)}),report.mills=u,t.union(i,function(t){o=new p(t),report.geometry=o,e.beginAnalysis()})},setTitleAndShowReport:function(e){document.getElementById("title").innerHTML=e,o.remove("report","hidden")},beginAnalysis:function(){function r(){e.length>0?(n=e.shift(),a(t._getDeferredsForItems(n)).then(r)):t.getFiresAnalysis()}var e=this._getArrayOfRequests(),t=this,n;report.areaPromise=b.getAreaFromGeometry(report.geometry),report.areaPromise.then(function(e){document.getElementById("total-area").innerHTML=e?e:"Not Available"}),a([b._getClearanceBounds()]).then(function(){e.length<3?a(t._getDeferredsForItems(e)).then(t.getFiresAnalysis.bind(t)):(e=e.chunk(3),r())})},getFiresAnalysis:function(){var e=this;a([b._getFireAlertAnalysis()]).then(e.analysisComplete)},analysisComplete:function(){b.setupMap(),o.remove("print","disabled"),e(t.byId("print"),"click",function(){u.set("total-area-info-popup","visibility","hidden"),window.print()}),n(".loader-wheel").forEach(function(e){e.parentNode.id!=="total-area"&&e.parentNode.id!=="print-map"&&(e.parentNode.innerHTML="There was an error getting these results at this time.")})},_getArrayOfRequests:function(){var e=[];for(var t in report.datasets)report.datasets[t]&&e.push(t);return e},_getDeferredsForItems:function(e){var t=[];return f.forEach(e,function(e){switch(e){case"suit":t.push(b._getSuitabilityAnalysis());break;case"mill":t.push(b._getMillPointAnalysis());break;case"carbon":t.push(b.getCarbonStocksResults());break;case"intact":t.push(b.getIntactForestResults());break;case"landCoverGlob":t.push(b.getLandCoverGlobalResults());break;case"landCoverAsia":t.push(b.getLandCoverAsiaResults());break;case"landCoverIndo":t.push(b.getLandCoverIndonesiaResults());break;case"legal":t.push(b.getLegalClassResults());break;case"peat":t.push(b.getPeatLandsResults());break;case"primForest":t.push(b.getPrimaryForestResults());break;case"protected":t.push(b.getProtectedAreaResults());break;case"rspo":t.push(b.getRSPOResults());break;case"treeDensity":t.push(b.getTreeCoverResults());break;case"treeCoverLoss":t.push(b.getTreeCoverLossResults());break;case"indonesiaMoratorium":t.push(b.getIndonesiaMoratoriumResults());break;default:}}),t},addSubscriptionDialog:function(){var n=new l({title:"Subscribe to Alerts!",style:"width: 300px;"}),r=this,i="<div class='subscription-content'><div class='checkbox-container'><label><input id='forma_check' type='checkbox' value='clearance' />Monthly Clearance Alerts</label></div><div class='checkbox-container'><label><input id='fires_check' type='checkbox' value='fires' />Fire Alerts</label></div><div class='email-container'><input id='user-email' type='text' placeholder='something@gmail.com'/></div><div class='submit-container'><button id='subscribe-now'>Subscribe</button></div><div id='form-response' class='message-container'></div></div>";n.setContent(i),e(t.byId("subscribeToAlerts"),"click",function(){n.show()}),e(t.byId("subscribe-now"),"click",function(){t.byId("form-response").innerHTML="<div class='loader-wheel subscribe'>subscribing</div>",r.subscribeToAlerts()})},subscribeToAlerts:function(){var e=this.convertGeometryToGeometric(report.geometry),n=t.byId("user-email").value,r=t.byId("forma_check").checked,i=t.byId("fires_check").checked,s=[],o={};o.invalidEmail="You must provide a valid email in the form.",o.noSelection="You must select at least one checkbox from the form.",o.formaSuccess="Thank you for subscribing to Forma Alerts.  You should receive a confirmation email soon.",o.formaFail="There was an error with your request to subscribe to Forma alerts.  Please try again later.",o.fireSuccess="Thank you for subscribing to Fires Alerts.  You should receive a confirmation email soon.",o.fireFail="There was an error with your request to subscribe to Fires alerts.  Please try again later.",c.isEmailAddress(n)||s.push(o.invalidEmail),!r&&!i&&s.push(o.noSelection);if(s.length>0)alert("Please fill in the following:\n"+s.join("\n"));else if(r&&i){var u=[];a([this.subscribeToForma(e,n),this.subscribeToFires(report.geometry,n)]).then(function(e){e[0]?u.push(o.formaSuccess):u.push(o.formaFail),e[1]?u.push(o.fireSuccess):u.push(o.fireFail),t.byId("form-response").innerHTML=u.join("<br />")})}else r?this.subscribeToForma(e,n).then(function(e){e?t.byId("form-response").innerHTML=o.formaSuccess:t.byId("form-response").innerHTML=o.formaFail}):i&&this.subscribeToFires(report.geometry,n).then(function(e){e?t.byId("form-response").innerHTML=o.fireSuccess:t.byId("form-response").innerHTML=o.fireFail})},subscribeToForma:function(e,t){var n=y.alertUrl.forma,r=new s,i=new XMLHttpRequest,o=JSON.stringify({topic:"updates/forma",geom:'{"type": "'+e.type+'", "coordinates":['+JSON.stringify(e.geom)+"]}",email:t}),u;return i.open("POST",n,!0),i.onreadystatechange=function(){i.readyState===4&&(u=JSON.parse(i.response),r.resolve(u.subscribe))},i.addEventListener("error",function(){r.resolve(!1)},!1),i.setRequestHeader("Content-type","application/x-www-form-urlencoded"),i.send(o),r.promise},subscribeToFires:function(e,t){var n=y.alertUrl.fires,r=new s,o={features:JSON.stringify({rings:e.rings,spatialReference:e.spatialReference}),msg_addr:t,msg_type:"email",area_name:payload.title},u;return i(n,{handleAs:"json",method:"POST",data:o}).then(function(){r.resolve(!0)},function(e){r.resolve(!1)}),r.promise},convertGeometryToGeometric:function(e){function o(e,t){var n=!1;return f.forEach(e,function(e){e[0]===t[0]&&e[1]===t[1]&&(n=!0)}),n}var t=new d({wkid:102100}),n=[],r=[],i,s;return f.forEach(e.rings,function(e){f.forEach(e,function(e){s=new h(e,t),i=m.xyToLngLat(s.x,s.y),o(r,i)?(r.push(i),n.push(r),r=[]):r.push(i)})}),{geom:n.length>1?n:n[0],type:n.length>1?"MultiPolygon":"Polygon"}}}}),function(){function e(e,t){var n,r,i;r=!1,n=document.createElement("script"),n.type="text/javascript",n.src=e,n.onload=n.onreadystatechange=function(){!r&&(!this.readyState||this.readyState=="complete")&&(r=!0,t())},i=document.getElementsByTagName("script")[0],i.parentNode.insertBefore(n,i)}require(["report/Generator"],function(t){var n=!1;e("http://code.jquery.com/jquery-1.11.0.min.js",function(){e("http://code.highcharts.com/highcharts.js",function(){e("http://code.highcharts.com/modules/exporting.js",function(){localStorage?(window.payload=JSON.parse(localStorage.getItem("payload")),window.payload&&(n=!0)):window.payload&&(n=!0),n?t.init():(document.addEventListener("PayloadReady",function(){n=!0}),setTimeout(function(){n&&window.payload?t.init():alert("There was an error generating the report at this time.  Please make sure your pop-up blocker is disabled and try again.")},5e3))})})})})}(),define("app/js/report/reportBundle",function(){});