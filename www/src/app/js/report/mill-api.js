define(["exports","esri/geometry/geometryEngineAsync","esri/tasks/BufferParameters","esri/tasks/GeometryService","esri/SpatialReference","esri/geometry/Polygon","esri/request","esri/config","dojo/Deferred","dojo/promise/all"],function(e,r,t,n,o,a,i,u,s,R){"use strict";function E(e){return e&&e.__esModule?e:{"default":e}}function _(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function c(e,r,t){var n=new A["default"];return(0,O["default"])({BUFFER:j(e,t||v.RADIUS),INDO:X(e)}).then(function(t){var o=t.BUFFER[0];U=t.INDO,(0,O["default"])({AREA:Z(o),LOSS_RATE:$(o),HISTORIC:ne(o),FUTURE:oe(o)}).then(function(t){n.resolve(ie(ae(t),e,r))})}),n}Object.defineProperty(e,"__esModule",{value:!0}),e["default"]=c;var S=E(r),m=E(t),l=E(n),d=E(o),f=E(a),I=E(i),T=E(u),A=E(s),O=E(R),g=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e},p=function(){function e(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(r,t,n){return t&&e(r.prototype,t),n&&e(r,n),r}}(),v={RADIUS:50,DENSITY:30,TIMEOUT:45e3,PIXEL_SIZE:100,FUTURE_YEAR_COUNT:2,CONTENT_FORMAT:"json",HISTORIC_YEAR_END_INDEX:11,HISTORIC_YEAR_START_INDEX:8,GEOMETRY_POINT:"esriGeometryPoint",GEOMETRY_POLYGON:"esriGeometryPolygon"},h={1:"low",2:"medium low",3:"medium",4:"medium high",5:"high"},P={ADD:1,MULTIPLY:3},y={mosaic:function(e){return{mosaicMethod:"esriMosaicLockRaster",mosaicOperation:"MT_FIRST",lockRasterIds:[e],ascending:!0}},arithmetic:function(e,r,t){return{rasterFunction:"Arithmetic",rasterFunctionArguments:{Raster:e,Raster2:r,Operation:t}}},remap:function(e,r,t){return{rasterFunction:"Remap",rasterFunctionArguments:{InputRanges:r,OutputValues:t,Raster:e,AllowUnmatched:!1}}}},C={FIRES_RASTER_URL:"http://gis-gfw.wri.org/arcgis/rest/services/image_services/annual_fires/ImageServer",IMAGE_SERVICE_URL:"http://gis-gfw.wri.org/arcgis/rest/services/image_services/analysis/ImageServer",GEOMETRY_SERVICE_URL:"http://gis-gfw.wri.org/arcgis/rest/services/Utilities/Geometry/GeometryServer",BOUNDARY_SERVICE_URL:"http://gis-potico.wri.org/arcgis/rest/services/CommoditiesAnalyzer/mapfeatures/MapServer/6",CANOPY_DENSITY_REMAP:y.remap("$520",[0,v.DENSITY,v.DENSITY,101],[0,1]),TREE_COVER_LOSS:{id:"$530",bounds:[1,14]},PRIMARY_FOREST:{id:"$519",bounds:[1,2]},PEAT:{id:"$8",bounds:[0,1]},PROTECTED_AREA:{id:"$10",bounds:[0,1]},CARBON:{id:"$524",bounds:[0,1],remap:y.remap("$524",[0,21,21,1e3],[0,1])},TREE_COVER_EXTENT:{id:"$520"},INTACT_FOREST_LANDSCAPE:{id:"$9"},FIRES:{PIXEL_SIZE:890.5559263,ID_09:1,ID_10:2,ID_11:3,ID_12:4,ID_13:5,ID_14:6,ID_15:7}},L={CARBON_AREA:{type:"percent",mean:97.67173618,std_dev:5.775175366},CARBON_LOSS:{type:"number",mean:55479.66071,std_dev:31676.19725},FIRE_ACTIVITY_FUTURE:{type:"number",mean:463888e-9,std_dev:781948e-9},FIRE_ACTIVITY_HISTORIC:{type:"number",mean:287583e-9,std_dev:336257e-9},WDPA_AREA:{type:"percent",mean:7.228910262,std_dev:8.985175562},WDPA_LOSS:{type:"number",mean:1119.288265,std_dev:2797.828324},PEAT_AREA:{type:"percent",mean:9.817356171,std_dev:12.76025748},PEAT_LOSS:{type:"number",mean:10890.62372,std_dev:19728.76226},PRIMARY_FOREST_AREA:{type:"percent",mean:12.5132604,std_dev:16.9831375},PRIMARY_FOREST_LOSS:{type:"number",mean:11965.28699,std_dev:22059.03368},TREE_COVER_FUTURE_RATE:{type:"number",mean:9321.90051,std_dev:4551.812568},TREE_COVER_LOSS_RATE:{type:"number",mean:13952.03571,std_dev:7912.007913}},U=void 0,F=new l["default"](C.GEOMETRY_SERVICE_URL);T["default"].defaults.io.corsEnabledServers.push("gis-gfw.wri.org"),T["default"].defaults.io.corsEnabledServers.push("gis-potico.wri.org");var N=function(e){var r=e.histograms,t=e.noSlice,n=r&&1===r.length?r[0].counts:[];return t?n:n.slice(1)},k=function(e){return parseInt(e.replace(/\$/,""))},Y=function(e,r){var t=e/r*100;return t>100?100:t},D=function(e,r,t){return(e-r)/t},M=function(e){var r=void 0;return r=e>=1?5:e>=.5&&.99>=e?4:e>=-.49&&.49>=e?3:e>=-.99&&-.49>=e?2:1,{score:r,zScore:e,rank:h[r]}},b=function(){return{score:1,zScore:-1,rank:h[1]}},z=function(e,r){var t=e*r,n=void 0;return n=t>=21?5:t>=16&&20>=t?4:t>=11&&15>=t?3:t>=5&&10>=t?2:1,h[n]},w=function(e){for(var r=0,t=v.HISTORIC_YEAR_START_INDEX;t<=v.HISTORIC_YEAR_END_INDEX;t++)e[t]&&(r+=e[t]);return r},V=function(e){for(var r=[],t=v.FUTURE_YEAR_COUNT;t>0;t--)r.push(e[e.length-t]||0);return r.reduce(function(e,r){return e+r},0)/r.length},B=function(e){for(var r=[],t=v.HISTORIC_YEAR_START_INDEX;t<=v.HISTORIC_YEAR_END_INDEX;t++)r.push(e[t]||0);return r.reduce(function(e,r){return e+r},0)/r.length},G=function(){function e(r,t){_(this,e),this.fromBounds=function(e){for(var r=[],t=e[1],n=e[0];t>=n;n++)r.push(n);return r},this.A=this.fromBounds(r),this.B=this.fromBounds(t)}return p(e,[{key:"encode",value:function(e,r){return this.B.length*e+r}},{key:"decode",value:function(e){var r=e%this.B.length,t=(e-r)/this.B.length;return[t,r]}},{key:"getSimpleRule",value:function(e,r){var t=C.CANOPY_DENSITY_REMAP,n=y.arithmetic(t,y.arithmetic(e,r,P.MULTIPLY),P.MULTIPLY);return n.rasterFunctionArguments.Raster2.outputPixelType="U8",n}},{key:"getRule",value:function(e,r){var t=y.remap(e,[this.A[0],this.A[this.A.length-1]+1],[this.B.length]),n=C.CANOPY_DENSITY_REMAP,o=y.arithmetic(n,y.arithmetic(y.arithmetic(t,e,P.MULTIPLY),r,P.ADD),P.MULTIPLY);return o.rasterFunctionArguments.Raster2.outputPixelType="U8",o}}]),e}(),x=function(e,r){return r.geometry&&(r.geometry=JSON.stringify(r.geometry)),r.renderingRule&&(r.renderingRule=JSON.stringify(r.renderingRule)),r.mosaicRule&&(r.mosaicRule=JSON.stringify(r.mosaicRule)),r.geometryType=r.geometryType||v.GEOMETRY_POLYGON,r.pixelSize=r.pixelSize||v.PIXEL_SIZE,r.f=r.f||v.CONTENT_FORMAT,(0,I["default"])({url:e+"/computeHistograms",callbackParamName:"callback",timeout:v.TIMEOUT,content:r,handleAs:"json"},{usePost:!0})},X=function(e){var r=new A["default"],t={where:"ISO = 'IDN'",geometryType:v.GEOMETRY_POINT,geometry:JSON.stringify(e),returnGeometry:!1,outFields:[],f:"json"};return(0,I["default"])({url:C.BOUNDARY_SERVICE_URL+"/query",callbackParamName:"callback",timeout:v.TIMEOUT,content:t,handleAs:"json"},{usePost:!0}).then(function(e){r.resolve(e&&e.features&&e.features.length>0)}),r},H=function(e){var r=new A["default"],t={geometryType:v.GEOMETRY_POLYGON,spatialRel:"esriSpatialRelIntersects",geometry:JSON.stringify(e),returnGeometry:!0,outFields:[""],outSR:54010,f:"json"};return(0,I["default"])({url:C.BOUNDARY_SERVICE_URL+"/query",callbackParamName:"callback",timeout:v.TIMEOUT,content:t,handleAs:"json"},{usePost:!0}).then(function(e){r.resolve(e.features)}),r},j=function(e,r){var t=new A["default"],n=new m["default"];return n.geometries=[e],n.distances=[r],n.unit=l["default"].UNIT_KILOMETER,n.outSpatialReference=new d["default"](54010),F.buffer(n,t.resolve,console.error),t},Z=function(e){var r=new A["default"],t={areaUnit:'{"areaUnit": "esriHectares"}',calculationType:"preserveShape",sr:54010,f:"json"};return H(e).then(function(n){var o=n.map(function(e){return new f["default"](e.geometry)});S["default"].intersect(o,e).then(function(e){t.polygons=JSON.stringify(e),(0,I["default"])({url:C.GEOMETRY_SERVICE_URL+"/areasAndLengths",callbackParamName:"callback",timeout:v.TIMEOUT,content:t,handleAs:"json"},{usePost:!0}).then(function(e){r.resolve(e.areas.reduce(function(e,r){return e+r},0))})})}),r},$=function(e){var r=new A["default"],t={geometry:e,pixelSize:v.PIXEL_SIZE,renderingRule:y.arithmetic(C.CANOPY_DENSITY_REMAP,C.TREE_COVER_LOSS.id,P.MULTIPLY)};return x(C.IMAGE_SERVICE_URL,t).then(function(e){r.resolve(N({histograms:e.histograms}))}),r},J=function(e){var r=new A["default"],t=new G(C.TREE_COVER_LOSS.bounds,C.PRIMARY_FOREST.bounds),n=t.getRule(C.TREE_COVER_LOSS.id,C.PRIMARY_FOREST.id),o={geometry:e,pixelSize:v.PIXEL_SIZE,renderingRule:n};return x(C.IMAGE_SERVICE_URL,o).then(function(e){for(var n=t.A,o=t.B,a=N({histograms:e.histograms,noSlice:!0}),i=[],u=0;u<n.length;u++){for(var s=0,R=0;R<o.length;R++){var E=t.encode(n[u],o[R]);s+=a[E]||0}i.push(s)}r.resolve(i)}),r},W=function(e){var r=new A["default"],t=new G(C.TREE_COVER_LOSS.bounds,C.PEAT.bounds),n=t.getSimpleRule(C.TREE_COVER_LOSS.id,C.PEAT.id),o={geometry:e,pixelSize:v.PIXEL_SIZE,renderingRule:n};return x(C.IMAGE_SERVICE_URL,o).then(function(e){r.resolve(N({histograms:e.histograms}))}),r},q=function(e){var r=new A["default"],t=new G(C.TREE_COVER_LOSS.bounds,C.PROTECTED_AREA.bounds),n=t.getSimpleRule(C.TREE_COVER_LOSS.id,C.PROTECTED_AREA.id),o={geometry:e,pixelSize:v.PIXEL_SIZE,renderingRule:n};return x(C.IMAGE_SERVICE_URL,o).then(function(e){r.resolve(N({histograms:e.histograms}))}),r},K=function(e){var r=new A["default"],t=new G(C.TREE_COVER_LOSS.bounds,C.CARBON.bounds),n=t.getRule(C.TREE_COVER_LOSS.id,C.CARBON.remap),o={geometry:e,pixelSize:v.PIXEL_SIZE,renderingRule:n};return x(C.IMAGE_SERVICE_URL,o).then(function(e){for(var n=t.A,o=t.B,a=N({histograms:e.histograms,noSlice:!0}),i=[],u=0;u<n.length;u++){for(var s=0,R=1;R<o.length;R++){var E=t.encode(n[u],o[R]);s+=a[E]||0}i.push(s)}r.resolve(i)}),r},Q=function(e,r){var t=new A["default"],n={geometry:r,pixelSize:v.PIXEL_SIZE,mosaicRule:y.mosaic(k(e))};return x(C.IMAGE_SERVICE_URL,n).then(function(e){if(e.histograms.length){var r=N({histograms:e.histograms});t.resolve(r.length?r.reduce(function(e,r){return e+r},0):0)}else t.resolve(0)},function(){t.resolve(0)}),t},ee=function(e){var r=new A["default"],t={geometry:e,pixelSize:v.PIXEL_SIZE,renderingRule:C.CARBON.remap};return x(C.IMAGE_SERVICE_URL,t).then(function(e){if(e.histograms.length){var t=N({histograms:e.histograms});r.resolve(t.length?t[0]:0)}else r.resolve(0)},function(){r.resolve(0)}),r},re=function(e){var r=new A["default"],t={geometry:e,pixelSize:C.FIRES.PIXEL_SIZE},n=g({},t,{mosaicRule:y.mosaic(C.FIRES.ID_09)}),o=g({},t,{mosaicRule:y.mosaic(C.FIRES.ID_10)}),a=g({},t,{mosaicRule:y.mosaic(C.FIRES.ID_11)}),i=g({},t,{mosaicRule:y.mosaic(C.FIRES.ID_12)});return(0,O["default"])([x(C.FIRES_RASTER_URL,n),x(C.FIRES_RASTER_URL,o),x(C.FIRES_RASTER_URL,a),x(C.FIRES_RASTER_URL,i)]).then(function(e){var t=e.map(function(e){var r=N({histograms:e.histograms,noSlice:!0});return r.reduce(function(e,r,t){return e+r*t},0)});r.resolve(t.reduce(function(e,r){return e+r},0)/t.length)}),r},te=function(e){var r=new A["default"],t={geometry:e,pixelSize:C.FIRES.PIXEL_SIZE},n=g({},t,{mosaicRule:y.mosaic(C.FIRES.ID_13)}),o=g({},t,{mosaicRule:y.mosaic(C.FIRES.ID_14)});return(0,O["default"])([x(C.FIRES_RASTER_URL,n),x(C.FIRES_RASTER_URL,o)]).then(function(e){var t=e.map(function(e){var r=N({histograms:e.histograms,noSlice:!0});return r.reduce(function(e,r,t){return e+r*t},0)});r.resolve(t.reduce(function(e,r){return e+r},0)/t.length)}),r},ne=function(e){return(0,O["default"])({PRIMARY_FOREST:J(e),PEAT:W(e),PROTECTED_AREA:q(e),CARBON:K(e),FIRE:re(e)})},oe=function(e){return(0,O["default"])({PRIMARY_FOREST:Q(C.PRIMARY_FOREST.id,e),PEAT:Q(C.PEAT.id,e),PROTECTED_AREA:Q(C.PROTECTED_AREA.id,e),CARBON:ee(e),IFL:Q(C.INTACT_FOREST_LANDSCAPE.id,e),FIRE:te(e)})},ae=function(e){var r=e.AREA,t=e.LOSS_RATE,n=e.HISTORIC,o=e.FUTURE,a=V(t,v.FUTURE_YEAR_COUNT),i=Y(U?o.PRIMARY_FOREST:o.IFL,r),u=Y(o.PEAT,r),s=Y(o.PROTECTED_AREA,r),R=Y(o.CARBON,r),E=o.FIRE/r,_=i?M(D(i,L.PRIMARY_FOREST_AREA.mean,L.PRIMARY_FOREST_AREA.std_dev)):b(),c=u?M(D(u,L.PEAT_AREA.mean,L.PEAT_AREA.std_dev)):b(),S=s?M(D(s,L.WDPA_AREA.mean,L.WDPA_AREA.std_dev)):b(),m=R?M(D(R,L.CARBON_AREA.mean,L.CARBON_AREA.std_dev)):b(),l=a?M(D(a,L.TREE_COVER_FUTURE_RATE.mean,L.TREE_COVER_FUTURE_RATE.std_dev)):b(),d=E?M(D(E,L.FIRE_ACTIVITY_FUTURE.mean,L.FIRE_ACTIVITY_FUTURE.std_dev)):b(),f=B(t),I=w(n.PRIMARY_FOREST),T=w(n.PEAT),A=w(n.PROTECTED_AREA),O=w(n.CARBON),p=n.FIRE/r,h=f?M(D(f,L.TREE_COVER_LOSS_RATE.mean,L.TREE_COVER_LOSS_RATE.std_dev)):b(),P=I?M(D(I,L.PRIMARY_FOREST_LOSS.mean,L.PRIMARY_FOREST_LOSS.std_dev)):b(),y=T?M(D(T,L.PEAT_LOSS.mean,L.PEAT_LOSS.std_dev)):b(),C=A?M(D(A,L.WDPA_LOSS.mean,L.WDPA_LOSS.std_dev)):b(),F=O?M(D(O,L.CARBON_LOSS.mean,L.CARBON_LOSS.std_dev)):b(),N=p?M(D(p,L.FIRE_ACTIVITY_HISTORIC.mean,L.FIRE_ACTIVITY_HISTORIC.std_dev)):b();return{HISTORIC:{primary_forest:g({amount:I},P),peat:g({amount:T},y),protected_areas:g({amount:A},C),carbon:g({amount:O},F),tree_cover:g({amount:f},h),fire:g({amount:p},N)},FUTURE:{primary_forest:g({amount:i},_),peat:g({amount:u},c),protected_areas:g({amount:s},S),carbon:g({amount:R},m),tree_cover:g({amount:a},l),fire:g({amount:E},d)}}},ie=function(e,r,t){var n=e.HISTORIC,o=e.FUTURE,a=0===o.tree_cover.zScore&&0===n.tree_cover.zScore,i=0===o.primary_forest.zScore&&0===n.primary_forest.zScore,u=0===o.peat.zScore&&0===n.peat.zScore,s=0===o.protected_areas.zScore&&0===n.protected_areas.zScore,R=0===o.carbon.zScore&&0===n.carbon.zScore,E=0===o.fire.zScore&&0===n.fire.zScore,_=(n.tree_cover.zScore+n.primary_forest.zScore+n.peat.zScore+n.protected_areas.zScore+n.carbon.zScore+n.fire.zScore)/6,c=(o.tree_cover.zScore+o.primary_forest.zScore+o.peat.zScore+o.protected_areas.zScore+o.carbon.zScore+o.fire.zScore)/6,S=M(_),m=M(c),l={};return r.getLatitude&&(l.latitude=r.getLatitude().toFixed(4)),r.getLongitude&&(l.longitude=r.getLongitude().toFixed(4)),g({tree_cover:{extent:{amount:o.tree_cover.amount,rank:o.tree_cover.rank},loss:{amount:n.tree_cover.amount,rank:n.tree_cover.rank},risk:a?b().rank:M((o.tree_cover.zScore+n.tree_cover.zScore)/2).rank},primary_forest:{extent:{amount:o.primary_forest.amount,rank:o.primary_forest.rank},loss:{amount:n.primary_forest.amount,rank:n.primary_forest.rank},risk:i?b().rank:M((o.primary_forest.zScore+n.primary_forest.zScore)/2).rank},peat:{extent:{amount:o.peat.amount,rank:o.peat.rank},loss:{amount:n.peat.amount,rank:n.peat.rank},risk:u?b().rank:M((o.peat.zScore+n.peat.zScore)/2).rank},protected_areas:{extent:{amount:o.protected_areas.amount,rank:o.protected_areas.rank},loss:{amount:n.protected_areas.amount,rank:n.protected_areas.rank},risk:s?b().rank:M((o.protected_areas.zScore+n.protected_areas.zScore)/2).rank},carbon:{extent:{amount:o.carbon.amount,rank:o.carbon.rank},loss:{amount:n.carbon.amount,rank:n.carbon.rank},risk:R?b().rank:M((o.carbon.zScore+n.carbon.zScore)/2).rank},fire:{extent:{amount:o.fire.amount,rank:o.fire.rank},loss:{amount:n.fire.amount,rank:n.fire.rank},risk:E?b().rank:M((o.fire.zScore+n.fire.zScore)/2).rank},historic_loss:S.rank,future_risk:m.rank,priority_level:z(S.score,m.score),mill_name:t||""},l)}});